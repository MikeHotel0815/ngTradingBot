<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>ngTradingBot Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Helvetica Neue', 'Arial', sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            color: #4CAF50;
            margin-bottom: 30px;
            font-size: 2em;
        }

        .info-bar {
            background: linear-gradient(135deg, #2d2d2d 0%, #353535 100%);
            padding: 20px 25px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: 180px 1px 180px 1px 1fr;
            grid-template-rows: auto auto;
            gap: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .info-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
            grid-row: span 2;
        }

        .info-section-title {
            font-size: 0.7em;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            margin-bottom: 2px;
        }

        .info-separator {
            width: 1px;
            background: #444;
            grid-row: span 2;
        }

        .info-row {
            display: grid;
            grid-template-columns: 60px 85px;
            gap: 8px;
            align-items: baseline;
        }

        .info-label {
            color: #999;
            font-size: 0.85em;
            white-space: nowrap;
            text-align: left;
        }

        .info-value {
            color: #4CAF50;
            font-weight: 600;
            font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'Helvetica Neue', sans-serif;
            text-align: right;
        }

        .balance-highlight {
            font-size: 1.3em;
            font-weight: 700;
        }

        /* Profit section */
        .profit-section {
            display: flex;
            flex-direction: column;
            gap: 10px;
            grid-row: span 2;
        }

        .profit-row {
            display: grid;
            grid-template-columns: 55px 70px;
            gap: 8px;
            align-items: baseline;
        }

        .profit-label {
            color: #999;
            font-size: 0.85em;
            white-space: nowrap;
        }

        .profit-value {
            font-weight: 600;
            font-family: 'Courier New', monospace;
            text-align: right;
        }

        .profit-positive {
            color: #4CAF50;
        }

        .profit-negative {
            color: #f44336;
        }

        .profit-neutral {
            color: #888;
        }

        /* Time section - top right */
        .time-section {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 15px;
        }

        .time-date {
            font-size: 1em;
            color: #fff;
            font-weight: 600;
        }

        .time-clock {
            font-size: 1.5em;
            color: #4CAF50;
            font-family: 'Courier New', monospace;
            font-weight: 700;
            letter-spacing: 1px;
        }

        .time-server {
            display: flex;
            justify-content: flex-end;
            font-size: 0.85em;
            color: #888;
            gap: 6px;
        }

        .time-server strong {
            color: #aaa;
            font-family: 'Courier New', monospace;
        }

        /* Stats section - centered */
        .stats-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }

        .stats-row {
            display: flex;
            gap: 20px;
            align-items: baseline;
            font-size: 0.9em;
        }

        .stat-item {
            display: flex;
            gap: 6px;
            align-items: baseline;
        }

        .stat-label {
            color: #999;
            font-size: 0.85em;
        }

        .stat-value {
            color: #4CAF50;
            font-weight: 600;
            font-family: 'Courier New', monospace;
            min-width: 60px;
            text-align: right;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #4CAF50;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: #2d2d2d;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }

        .card h2 {
            color: #4CAF50;
            margin-bottom: 15px;
            font-size: 1.3em;
            border-bottom: 2px solid #3d3d3d;
            padding-bottom: 10px;
        }

        .symbol-item {
            background: #3d3d3d;
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 8px;
            display: grid;
            grid-template-columns: 80px auto 1fr;
            align-items: center;
            gap: 20px;
        }

        .symbol-name {
            font-size: 1.1em;
            font-weight: bold;
            color: #fff;
            white-space: nowrap;
        }

        .symbol-main {
            display: flex;
            flex-direction: column;
            gap: 6px;
            justify-content: center;
        }

        .price-container {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        /* Signals Styling */
        .signals-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }

        .signals-filter select {
            background: #3d3d3d;
            color: #e0e0e0;
            border: 1px solid #555;
            padding: 8px 12px;
            border-radius: 4px;
            font-size: 0.9em;
            cursor: pointer;
        }

        .signals-filter select:hover {
            background: #4d4d4d;
        }

        /* Slider styling */
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background: #4CAF50;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        /* Clickable countdown timer */
        .signal-countdown-container {
            transition: all 0.2s ease;
            padding: 5px 10px;
            border-radius: 5px;
            background: rgba(76, 175, 80, 0.1);
        }

        .signal-countdown-container:hover {
            background: rgba(76, 175, 80, 0.25);
            transform: scale(1.05);
        }

        .signal-countdown-container:active {
            transform: scale(0.98);
        }

        .signal-item {
            background: #3d3d3d;
            padding: 8px 15px;
            border-radius: 5px;
            margin-bottom: 8px;
            border-left: 4px solid #4CAF50;
            display: grid;
            grid-template-columns: repeat(12, 1fr);
            grid-template-rows: auto auto auto;
            gap: 4px 8px;
        }

        .signal-item.signal-sell {
            border-left-color: #f44336;
        }

        .signal-header {
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 0;
        }

        .signal-symbol {
            font-size: 1.1em;
            font-weight: bold;
            color: #fff;
            min-width: 85px;
            width: 85px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .signal-timeframe {
            background: #555;
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 0.8em;
            color: #e0e0e0;
            min-width: 38px;
            text-align: center;
        }

        .signal-confidence {
            font-size: 0.95em;
            font-weight: bold;
            padding: 3px 10px;
            border-radius: 4px;
            min-width: 50px;
            width: 50px;
            text-align: center;
        }

        .signal-confidence.high {
            background: #4CAF50;
            color: #fff;
        }

        .signal-confidence.medium {
            background: #ff9800;
            color: #fff;
        }

        .signal-confidence.low {
            background: #666;
            color: #ddd;
        }

        .signal-type {
            font-size: 0.85em;
            font-weight: 600;
            padding: 3px 10px;
            border-radius: 3px;
            min-width: 60px;
            text-align: center;
        }

        .signal-type.buy {
            color: #4CAF50;
        }

        .signal-type.sell {
            color: #f44336;
        }

        .signal-prices {
            display: grid;
            grid-template-columns: 120px 100px 100px 70px 70px 80px;
            gap: 10px;
            align-items: center;
            font-size: 0.85em;
            flex: 1;
        }

        .signal-price-item {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            gap: 2px;
            min-width: 0;
        }

        .signal-price-label {
            color: #999;
            font-size: 0.75em;
            white-space: nowrap;
        }

        .signal-price-value {
            color: #e0e0e0;
            font-weight: 600;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%;
        }

        .signal-reasons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            font-size: 0.75em;
            color: #999;
            max-height: 3em;
            overflow: hidden;
        }

        .signal-reasons-title {
            display: none;
        }

        .signal-reason {
            color: #4CAF50;
            font-size: 0.8em;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .signal-reason::before {
            content: '‚úì ';
            color: #4CAF50;
        }

        .no-signals {
            text-align: center;
            padding: 30px;
            color: #888;
            font-size: 0.95em;
        }

        .signal-indicator {
            margin-left: 8px;
            font-size: 0.9em;
            padding: 2px 6px;
            border-radius: 3px;
            background: #4CAF50;
            color: #fff;
            font-weight: 600;
        }

        .signal-indicator.sell {
            background: #f44336;
        }

        .signal-actions {
            display: flex;
            align-items: center;
            margin-left: auto;
            flex-shrink: 0;
            min-width: fit-content;
        }

        .trade-btn {
            padding: 8px 16px;
            font-size: 0.85em;
            font-weight: 600;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
            flex-shrink: 0;
        }

        .trade-btn-buy {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
        }

        .trade-btn-buy:hover {
            background: linear-gradient(135deg, #45a049, #3d8b40);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
        }

        .trade-btn-sell {
            background: linear-gradient(135deg, #f44336, #da190b);
            color: white;
        }

        .trade-btn-sell:hover {
            background: linear-gradient(135deg, #da190b, #c1170a);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.4);
        }

        .trade-btn:active {
            transform: translateY(0);
        }

        .trade-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .trends-container {
            display: flex;
            gap: 15px;
            align-items: center;
            justify-content: flex-end;
        }

        .trend-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
        }

        .trend-label {
            font-size: 0.7em;
            color: #888;
            font-weight: 600;
        }

        .trend-arrow {
            font-size: 1.4em;
            line-height: 1;
        }

        .trend-up { color: #4CAF50; }
        .trend-down { color: #f44336; }
        .trend-neutral { color: #666; }

        .price-item {
            display: grid;
            grid-template-columns: 30px 1fr;
            align-items: baseline;
            gap: 6px;
            min-width: 150px;
        }

        .price-label {
            font-size: 0.75em;
            color: #888;
            text-align: left;
        }

        .price-value {
            font-size: 1em;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            text-align: right;
            transition: transform 0.2s ease;
        }

        .price-bid { color: #f44336; }
        .price-ask { color: #4CAF50; }

        .price-pulse {
            animation: pulse-price 0.4s ease;
        }

        @keyframes pulse-price {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.15); }
        }

        /* P/L fade animation - fades to white and back to original color */
        .pnl-fade {
            animation: pnl-fade-animation 0.6s ease;
        }

        @keyframes pnl-fade-animation {
            0% {
                filter: brightness(1);
            }
            50% {
                filter: brightness(3);
                color: #ffffff;
            }
            100% {
                filter: brightness(1);
            }
        }

        .signal-updated {
            animation: signal-flash 0.6s ease;
        }

        @keyframes signal-flash {
            0%, 100% { background: linear-gradient(135deg, #2d2d2d 0%, #353535 100%); }
            50% { background: linear-gradient(135deg, #3d4d3d 0%, #455545 100%); }
        }

        .tick-info {
            font-size: 0.75em;
            color: #888;
            min-width: 120px;
            text-align: right;
        }


        .no-data {
            text-align: center;
            color: #888;
            padding: 20px;
        }

        .refresh-info {
            text-align: center;
            color: #888;
            font-size: 0.9em;
            margin-top: 20px;
        }

        /* Trading Statistics Styles */
        .stat-period-card {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid #4CAF50;
        }

        .stat-period-title {
            font-size: 0.9em;
            color: #888;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            font-size: 0.85em;
        }

        .stat-row .label {
            color: #aaa;
        }

        .stat-row .value {
            color: #e0e0e0;
            font-weight: 600;
        }

        .stat-row .value.positive {
            color: #4CAF50;
        }

        .stat-row .value.negative {
            color: #f44336;
        }

        /* Open Trades Styles */
        .trades-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 15px;
        }

        .trade-card {
            background: #2d2d2d;
            border-radius: 8px;
            padding: 15px;
            border-left: 4px solid #666;
        }

        .trade-card.profit {
            border-left-color: #4CAF50;
        }

        .trade-card.loss {
            border-left-color: #f44336;
        }

        .trade-card-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .trade-symbol {
            font-size: 1.1em;
            font-weight: 700;
            color: #e0e0e0;
        }

        .trade-direction {
            padding: 2px 8px;
            border-radius: 3px;
            font-size: 0.8em;
            font-weight: 600;
        }

        .trade-direction.buy {
            background: #4CAF50;
            color: white;
        }

        .trade-direction.sell {
            background: #f44336;
            color: white;
        }

        .trade-pnl {
            font-size: 1.3em;
            font-weight: 700;
            margin: 10px 0;
        }

        .trade-pnl.profit {
            color: #4CAF50;
        }

        .trade-pnl.loss {
            color: #f44336;
        }

        .trade-info-row {
            display: flex;
            justify-content: space-between;
            font-size: 0.85em;
            padding: 3px 0;
            color: #aaa;
        }

        .trade-info-row .value {
            color: #e0e0e0;
        }

        /* Trade History Styles */
        .trade-filters select {
            background: #2a2a2a;
            color: #e0e0e0;
            border: 1px solid #444;
            padding: 8px 12px;
            border-radius: 5px;
            font-size: 0.9em;
            cursor: pointer;
        }

        .trade-filters select:hover {
            border-color: #4CAF50;
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
        }

        .history-table th {
            background: #2a2a2a;
            padding: 10px;
            text-align: left;
            color: #888;
            font-weight: 600;
            border-bottom: 2px solid #444;
        }

        .history-table td {
            padding: 10px;
            border-bottom: 1px solid #333;
        }

        .history-table tr:hover {
            background: #252525;
        }

        .pagination-btn {
            background: #2a2a2a;
            color: #e0e0e0;
            border: 1px solid #444;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .pagination-btn:hover:not(:disabled) {
            background: #4CAF50;
            border-color: #4CAF50;
        }

        .pagination-btn:disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }

        .pagination-btn.active {
            background: #4CAF50;
            border-color: #4CAF50;
        }

        /* Trade Action Buttons */
        .trade-action-btn {
            flex: 1;
            padding: 8px 12px;
            border: none;
            border-radius: 5px;
            font-size: 0.85em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .trade-close-btn {
            background: #f44336;
            color: white;
        }

        .trade-close-btn:hover {
            background: #d32f2f;
            transform: translateY(-1px);
        }

        .trade-ts-btn {
            background: #2196F3;
            color: white;
        }

        .trade-ts-btn:hover {
            background: #1976D2;
            transform: translateY(-1px);
        }

        .global-action-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            margin-left: 10px;
        }

        .close-profitable-btn {
            background: #4CAF50;
            color: white;
        }

        .close-profitable-btn:hover {
            background: #45a049;
        }

        .close-all-btn {
            background: #ff9800;
            color: white;
        }

        .close-all-btn:hover {
            background: #f57c00;
        }

        /* Modal Styles */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 10000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: #2d2d2d;
            border-radius: 12px;
            padding: 30px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
        }

        .modal-title {
            font-size: 1.3em;
            margin-bottom: 20px;
            color: #e0e0e0;
        }

        .modal-input {
            width: 100%;
            padding: 12px;
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 5px;
            color: #e0e0e0;
            font-size: 1em;
            margin-bottom: 20px;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 5px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
        }

        .modal-btn-primary {
            background: #4CAF50;
            color: white;
        }

        .modal-btn-primary:hover {
            background: #45a049;
        }

        .modal-btn-cancel {
            background: #666;
            color: white;
        }

        .modal-btn-cancel:hover {
            background: #555;
        }

        .modal-btn-danger {
            background: #f44336;
            color: white;
        }

        .modal-btn-danger:hover {
            background: #d32f2f;
        }
    </style>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
</head>
<body>
    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h1 style="margin: 0;">ü§ñ ngTradingBot Dashboard</h1>
            <button onclick="showSettingsModal()" style="background: #666; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 1em;">
                ‚öôÔ∏è Global Settings
            </button>
        </div>

        <div class="info-bar">
            <!-- Account Section (Left - spans 2 rows) -->
            <div class="info-section">
                <div class="info-section-title">üìä Account</div>
                <div class="info-row">
                    <div class="status-dot"></div>
                    <span class="info-value">#<span id="account-number">-</span></span>
                </div>
                <div class="info-row">
                    <span class="info-label">Balance:</span>
                    <span class="info-value balance-highlight" id="balance">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Equity:</span>
                    <span class="info-value" id="equity">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Margin:</span>
                    <span class="info-value" id="margin">-</span>
                </div>
                <div class="info-row">
                    <span class="info-label">Free:</span>
                    <span class="info-value" id="free-margin">-</span>
                </div>
            </div>

            <!-- Separator (spans 2 rows) -->
            <div class="info-separator"></div>

            <!-- Profit Section (spans 2 rows) -->
            <div class="profit-section">
                <div class="info-section-title">üí∞ Profit</div>
                <div class="profit-row">
                    <span class="profit-label">Today:</span>
                    <span class="profit-value profit-neutral" id="profit-today">‚Ç¨0.00</span>
                </div>
                <div class="profit-row">
                    <span class="profit-label">Week:</span>
                    <span class="profit-value profit-neutral" id="profit-week">‚Ç¨0.00</span>
                </div>
                <div class="profit-row">
                    <span class="profit-label">Month:</span>
                    <span class="profit-value profit-neutral" id="profit-month">‚Ç¨0.00</span>
                </div>
                <div class="profit-row">
                    <span class="profit-label">Year:</span>
                    <span class="profit-value profit-neutral" id="profit-year">‚Ç¨0.00</span>
                </div>
            </div>

            <!-- Separator (spans 2 rows) -->
            <div class="info-separator"></div>

            <!-- Time Section (Top Right) -->
            <div class="time-section">
                <span class="time-date">üìÖ <span id="current-date">-</span></span>
                <span class="time-clock">üïê <span id="local-time">-</span></span>
            </div>

            <!-- Database Section (Center Bottom) -->
            <div class="stats-section">
                <div class="info-section-title">üíæ Database</div>
                <div class="stats-row">
                    <div class="stat-item">
                        <span class="stat-label">Size:</span>
                        <span class="stat-value" id="db-size">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">Ticks:</span>
                        <span class="stat-value" id="tick-count">-</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-label">OHLC:</span>
                        <span class="stat-value" id="ohlc-count">-</span>
                    </div>
                </div>
                <div class="time-server">
                    <span>üåê Server:</span>
                    <strong id="server-time">-</strong>
                </div>
            </div>
        </div>

        <!-- ‚úÖ NEW: Safety Monitor Widget -->
        <div class="safety-monitor-widget" id="safety-monitor" style="
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            border-radius: 8px;
            padding: 15px 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            border-left: 4px solid #4CAF50;
        ">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div id="safety-health-indicator" style="
                        width: 12px;
                        height: 12px;
                        border-radius: 50%;
                        background: #4CAF50;
                        box-shadow: 0 0 10px #4CAF50;
                        animation: pulse 2s infinite;
                    "></div>
                    <h3 style="margin: 0; color: white; font-size: 1.1em;">
                        üõ°Ô∏è Safety Monitor: <span id="safety-status-text">HEALTHY</span>
                    </h3>
                </div>
                <button onclick="toggleSafetyDetails()" style="
                    background: rgba(255,255,255,0.1);
                    color: white;
                    border: 1px solid rgba(255,255,255,0.3);
                    padding: 5px 15px;
                    border-radius: 5px;
                    cursor: pointer;
                    font-size: 0.9em;
                ">
                    <span id="safety-toggle-icon">‚ñº</span> Details
                </button>
            </div>

            <div id="safety-messages" style="margin-top: 10px; font-size: 0.9em; color: rgba(255,255,255,0.9);"></div>

            <!-- Details Panel (Collapsible) -->
            <div id="safety-details" style="display: none; margin-top: 15px; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 15px;">
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 15px;">
                    <!-- Circuit Breaker -->
                    <div class="safety-detail-card">
                        <div class="safety-detail-title">‚ö° Circuit Breaker</div>
                        <div id="circuit-breaker-status" class="safety-detail-content">
                            <div>Status: <span id="cb-status">-</span></div>
                            <div>Failed Commands: <span id="cb-failed-count">0</span></div>
                        </div>
                    </div>

                    <!-- Position Limits -->
                    <div class="safety-detail-card">
                        <div class="safety-detail-title">üìä Position Limits</div>
                        <div id="position-limits-status" class="safety-detail-content">
                            <div>Open: <span id="pos-open">0</span> / <span id="pos-max">5</span></div>
                            <div>Utilization: <span id="pos-util">0%</span></div>
                        </div>
                    </div>

                    <!-- Daily Drawdown -->
                    <div class="safety-detail-card">
                        <div class="safety-detail-title">üìâ Daily Drawdown</div>
                        <div id="daily-drawdown-status" class="safety-detail-content">
                            <div>P&L: <span id="dd-pnl">‚Ç¨0.00</span></div>
                            <div>Limit: <span id="dd-limit">-</span></div>
                        </div>
                    </div>

                    <!-- SL-Hit Cooldowns -->
                    <div class="safety-detail-card">
                        <div class="safety-detail-title">üïê SL-Hit Cooldowns</div>
                        <div id="sl-cooldowns-status" class="safety-detail-content">
                            <div id="sl-cooldowns-list">None active</div>
                        </div>
                    </div>

                    <!-- Multi-Timeframe Conflicts -->
                    <div class="safety-detail-card">
                        <div class="safety-detail-title">‚ö†Ô∏è MTF Conflicts</div>
                        <div id="mtf-conflicts-status" class="safety-detail-content">
                            <div id="mtf-conflicts-list">No conflicts</div>
                        </div>
                    </div>

                    <!-- News Filter -->
                    <div class="safety-detail-card">
                        <div class="safety-detail-title">üì∞ News Filter</div>
                        <div id="news-filter-status" class="safety-detail-content">
                            <div>Upcoming Events: <span id="news-event-count">0</span></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <style>
            @keyframes pulse {
                0%, 100% { opacity: 1; }
                50% { opacity: 0.5; }
            }

            .safety-detail-card {
                background: rgba(0,0,0,0.2);
                border-radius: 5px;
                padding: 10px;
            }

            .safety-detail-title {
                font-weight: bold;
                color: white;
                margin-bottom: 8px;
                font-size: 0.95em;
            }

            .safety-detail-content {
                color: rgba(255,255,255,0.85);
                font-size: 0.85em;
                line-height: 1.6;
            }

            .safety-detail-content div {
                margin-bottom: 3px;
            }
        </style>

        <div class="grid">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2 style="margin: 0;">üéØ Trading Signals</h2>
                    <div class="signal-countdown-container"
                         style="font-size: 1.1em; color: #4CAF50; font-weight: 600; cursor: pointer; user-select: none;"
                         onclick="triggerImmediateSignalUpdate()"
                         title="Click to trigger immediate signal discovery">
                        üîÑ Update: <span id="signal-countdown">10</span>s <span id="volatility-level"></span>
                    </div>
                </div>
                <div class="signals-filter">
                    <select id="signal-timeframe" onchange="updateSignals()">
                        <option value="">Alle Timeframes</option>
                        <option value="H1">H1</option>
                        <option value="H4">H4</option>
                    </select>
                    <div style="display: flex; align-items: center; gap: 10px; min-width: 250px;">
                        <label for="signal-confidence-slider" style="white-space: nowrap; font-size: 0.9em; color: #888;">
                            Confidence ‚â• <span id="confidence-value" style="color: #4CAF50; font-weight: 600;">40</span>%
                        </label>
                        <input type="range" id="signal-confidence-slider" min="40" max="100" step="5" value="40"
                               style="flex: 1; height: 6px; background: linear-gradient(to right, #f44336 0%, #ff9800 50%, #4CAF50 100%); border-radius: 3px; outline: none; -webkit-appearance: none;">
                    </div>
                    <select id="signal-type" onchange="updateSignals()">
                        <option value="">Alle Typen</option>
                        <option value="BUY">BUY</option>
                        <option value="SELL">SELL</option>
                    </select>
                </div>
                <div id="autotrade-settings" style="margin-top: 10px; padding: 10px; background: #2a2a2a; border-radius: 5px; border-left: 3px solid #4CAF50;">
                    <div style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; white-space: nowrap;">
                            <input type="checkbox" id="autotrade-enabled" style="width: 18px; height: 18px; cursor: pointer;">
                            <span style="font-size: 0.9em; color: #888;">AutoTrade</span>
                        </label>
                        
                        <!-- Risk Profile Selector (replaces slider) -->
                        <div style="display: flex; gap: 8px; flex: 1; min-width: 350px;">
                            <span style="font-size: 0.85em; color: #888; margin-right: 5px;">Risk:</span>
                            <button id="risk-moderate" class="risk-profile-btn" data-profile="moderate" 
                                    style="flex: 1; padding: 6px 12px; border: 2px solid #555; background: #2a2a2a; color: #888; border-radius: 5px; cursor: pointer; font-size: 0.85em; transition: all 0.2s;">
                                üõ°Ô∏è MODERATE<br><span style="font-size: 0.7em; opacity: 0.7;">Conservative</span>
                            </button>
                            <button id="risk-normal" class="risk-profile-btn active" data-profile="normal"
                                    style="flex: 1; padding: 6px 12px; border: 2px solid #4CAF50; background: #1a4a1a; color: #4CAF50; border-radius: 5px; cursor: pointer; font-size: 0.85em; font-weight: 600; transition: all 0.2s;">
                                ‚öñÔ∏è NORMAL<br><span style="font-size: 0.7em; opacity: 0.7;">Balanced</span>
                            </button>
                            <button id="risk-aggressive" class="risk-profile-btn" data-profile="aggressive"
                                    style="flex: 1; padding: 6px 12px; border: 2px solid #555; background: #2a2a2a; color: #888; border-radius: 5px; cursor: pointer; font-size: 0.85em; transition: all 0.2s;">
                                üöÄ AGGRESSIVE<br><span style="font-size: 0.7em; opacity: 0.7;">Risk-seeking</span>
                            </button>
                        </div>
                        
                        <label style="display: flex; align-items: center; gap: 5px; cursor: pointer; white-space: nowrap;">
                            <input type="checkbox" id="autotrade-trailing-stop" checked style="width: 18px; height: 18px; cursor: pointer;">
                            <span style="font-size: 0.9em; color: #888;">Trailing Stop</span>
                        </label>
                    </div>
                    
                    <!-- Dynamic Confidence Requirements Display -->
                    <div id="confidence-requirements" style="margin-top: 10px; padding: 8px; background: #1a1a1a; border-radius: 4px; font-size: 0.8em; color: #888; display: none;">
                        <div style="margin-bottom: 4px;">
                            <strong style="color: #4CAF50;">Current Requirements</strong> 
                            <span id="current-session" style="margin-left: 10px; color: #ff9800;"></span>
                        </div>
                        <div id="requirements-list" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 6px;"></div>
                    </div>
                </div>
                <div id="signals-list"></div>
            </div>
        </div>

        <!-- SYMBOL PERFORMANCE TRACKING -->
        <div class="grid">
            <div class="card">
                <h2>üéØ Symbol Performance (Live 24h)</h2>
                <div id="symbol-performance-container" style="margin-top: 15px;">
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="border-bottom: 2px solid #444; text-align: left;">
                                <th style="padding: 10px;">Symbol</th>
                                <th style="padding: 10px;">Status</th>
                                <th style="padding: 10px; text-align: right;">Trades</th>
                                <th style="padding: 10px; text-align: right;">Win-Rate</th>
                                <th style="padding: 10px; text-align: right;">Profit</th>
                                <th style="padding: 10px;">Reason</th>
                            </tr>
                        </thead>
                        <tbody id="symbol-performance-list">
                            <tr><td colspan="6" style="text-align: center; padding: 20px; color: #888;">Loading performance data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- TRADING STATISTICS -->
        <div class="grid">
            <div class="card">
                <h2>üìà Trading Statistics</h2>
                <div id="trading-statistics">
                    <div class="stats-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-top: 15px;">
                        <div class="stat-period-card" id="stats-today"></div>
                        <div class="stat-period-card" id="stats-week"></div>
                        <div class="stat-period-card" id="stats-month"></div>
                        <div class="stat-period-card" id="stats-all-time"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI DECISION LOG -->
        <div class="grid">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <h2 style="margin: 0;">ü§ñ AI Decision Log</h2>
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <span id="action-required-badge" style="display: none; background: #f44336; color: white; padding: 5px 10px; border-radius: 12px; font-size: 0.85em; font-weight: 600;">
                            ‚ö†Ô∏è <span id="action-required-count">0</span> Action Required
                        </span>
                        <select id="decision-type-filter" style="padding: 5px 10px; background: #2a2a2a; border: 1px solid #444; border-radius: 4px; color: #fff; font-size: 0.9em;">
                            <option value="">All Decisions</option>
                            <option value="TRADE_OPEN">Trade Open</option>
                            <option value="TRADE_CLOSE">Trade Close</option>
                            <option value="SIGNAL_SKIP">Signal Skip</option>
                            <option value="SYMBOL_DISABLE">Symbol Disable</option>
                            <option value="SYMBOL_ENABLE">Symbol Enable</option>
                            <option value="RISK_LIMIT">Risk Limit</option>
                            <option value="CORRELATION_BLOCK">Correlation Block</option>
                            <option value="NEWS_PAUSE">News Pause</option>
                            <option value="DD_LIMIT">DD Limit</option>
                            <option value="SUPERTREND_SL">SuperTrend SL</option>
                            <option value="MTF_CONFLICT">MTF Conflict</option>
                        </select>
                    </div>
                </div>
                <div id="ai-decision-log-container" style="max-height: 400px; overflow-y: auto;">
                    <div style="text-align: center; padding: 20px; color: #888;">Loading decisions...</div>
                </div>
            </div>
        </div>

        <!-- OPEN POSITIONS -->
        <div class="grid">
            <div class="card">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                    <div style="display: flex; align-items: center; gap: 15px;">
                        <h2 style="margin: 0;">üìä Open Positions (<span id="open-trades-count">0</span>)</h2>
                        <span style="font-size: 0.9em; color: #888;">
                            üîÑ <span id="positions-last-update" style="font-weight: 600;">--:--:--</span>
                        </span>
                    </div>
                    <div>
                        <button onclick="closeAllProfitable()" class="global-action-btn close-profitable-btn" title="Close all trades currently in profit">
                            ‚úì Close Profitable
                        </button>
                        <button onclick="confirmCloseAll()" class="global-action-btn close-all-btn" title="Close ALL open trades">
                            ‚úï Close All
                        </button>
                    </div>
                </div>
                <div id="open-trades-list">
                    <div style="text-align: center; color: #888; padding: 20px;">Loading...</div>
                </div>
            </div>
        </div>

        <!-- TRADE HISTORY -->
        <div class="grid">
            <div class="card">
                <h2>üìú Trade History</h2>
                <div class="trade-filters" style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 15px;">
                    <select id="history-period" onchange="loadTradeHistory()">
                        <option value="all">All Time</option>
                        <option value="today">Today</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="year">This Year</option>
                    </select>
                    <select id="history-symbol" onchange="loadTradeHistory()">
                        <option value="">All Symbols</option>
                    </select>
                    <select id="history-direction" onchange="loadTradeHistory()">
                        <option value="">All Directions</option>
                        <option value="BUY">Buy</option>
                        <option value="SELL">Sell</option>
                    </select>
                    <select id="history-profit-status" onchange="loadTradeHistory()">
                        <option value="">All</option>
                        <option value="profit">Profitable</option>
                        <option value="loss">Loss</option>
                    </select>
                </div>
                <div id="trade-history-list" style="overflow-x: auto;">
                    <div style="text-align: center; color: #888; padding: 20px;">Loading...</div>
                </div>
                <div id="trade-pagination" style="display: flex; justify-content: center; gap: 10px; margin-top: 15px; align-items: center;"></div>
            </div>
        </div>

        <div class="grid">
            <div class="card">
                <h2>üìä Abonnierte Symbole & Live-Kurse</h2>
                <div id="symbols-list"></div>
            </div>
        </div>

        <div class="refresh-info">
            Dashboard aktualisiert sich in Echtzeit (WebSocket)
        </div>
    </div>

    <script>
        // Initialize Socket.IO with explicit configuration
        // WebSocket runs on port 9905 (same as web UI), NOT 9900 (API only)
        const socketUrl = window.location.protocol + '//' + window.location.hostname + ':9905';
        const socket = io(socketUrl, {
            transports: ['websocket', 'polling'],
            reconnection: true,
            reconnectionDelay: 1000,
            reconnectionAttempts: 10
        });
        const previousPrices = {}; // Track previous prices for pulse animation

        // Update profit display with color
        function updateProfitValue(elementId, value) {
            const element = document.getElementById(elementId);
            if (!element) return;

            // Check if value actually changed
            const oldValue = parseFloat(element.dataset.currentValue || '0');
            const newValue = parseFloat(value);
            const valueChanged = oldValue !== newValue;

            // Store new value
            element.dataset.currentValue = newValue;

            element.textContent = '‚Ç¨' + value.toFixed(2);

            // Remove all color classes
            element.classList.remove('profit-positive', 'profit-negative', 'profit-neutral');

            // Add appropriate color class
            if (value > 0) {
                element.classList.add('profit-positive');
            } else if (value < 0) {
                element.classList.add('profit-negative');
            } else {
                element.classList.add('profit-neutral');
            }

            // Only pulse if value actually changed
            if (valueChanged) {
                element.classList.add('price-pulse');
                setTimeout(() => element.classList.remove('price-pulse'), 400);
            }
        }

        // Update account status
        async function updateAccountStatus() {
            try {
                const response = await fetch('/api/dashboard/status');
                const data = await response.json();

                if (data.status === 'success' && data.account) {
                    document.getElementById('account-number').textContent = data.account.number;
                    document.getElementById('balance').textContent = '‚Ç¨' + (data.account.balance || 0).toFixed(2);
                    document.getElementById('equity').textContent = '‚Ç¨' + (data.account.equity || 0).toFixed(2);
                    document.getElementById('margin').textContent = '‚Ç¨' + (data.account.margin || 0).toFixed(2);
                    document.getElementById('free-margin').textContent = '‚Ç¨' + (data.account.free_margin || 0).toFixed(2);

                    // Update profit values
                    updateProfitValue('profit-today', data.account.profit_today || 0);
                    updateProfitValue('profit-week', data.account.profit_week || 0);
                    updateProfitValue('profit-month', data.account.profit_month || 0);
                    updateProfitValue('profit-year', data.account.profit_year || 0);
                }
            } catch (error) {
                console.error('Error fetching status:', error);
            }
        }

        // Update info bar (database, time, etc.)
        async function updateInfoBar() {
            try {
                const response = await fetch('/api/dashboard/info');
                const data = await response.json();

                if (data.status === 'success' && data.info) {
                    const info = data.info;
                    document.getElementById('current-date').textContent = info.weekday + ', ' + info.date;
                    document.getElementById('local-time').textContent = info.local_time;
                    document.getElementById('server-time').textContent = info.server_time;
                    document.getElementById('db-size').textContent = info.db_size;
                    document.getElementById('tick-count').textContent = info.tick_count.toLocaleString('de-DE');
                    document.getElementById('ohlc-count').textContent = info.ohlc_count.toLocaleString('de-DE');
                }
            } catch (error) {
                console.error('Error fetching info:', error);
            }
        }

        // Update symbols and prices
        async function updateSymbols() {
            try {
                const response = await fetch('/api/dashboard/symbols');
                const data = await response.json();

                if (data.status === 'success') {
                    // Update account data if present
                    if (data.account) {
                        document.getElementById('account-number').textContent = data.account.number;
                        document.getElementById('balance').textContent = '‚Ç¨' + (data.account.balance || 0).toFixed(2);
                        document.getElementById('equity').textContent = '‚Ç¨' + (data.account.equity || 0).toFixed(2);
                        document.getElementById('margin').textContent = '‚Ç¨' + (data.account.margin || 0).toFixed(2);
                        document.getElementById('free-margin').textContent = '‚Ç¨' + (data.account.free_margin || 0).toFixed(2);

                        // Update profit values
                        updateProfitValue('profit-today', data.account.profit_today);
                        updateProfitValue('profit-week', data.account.profit_week);
                        updateProfitValue('profit-month', data.account.profit_month);
                        updateProfitValue('profit-year', data.account.profit_year);
                    }

                    const container = document.getElementById('symbols-list');

                    if (data.symbols.length === 0) {
                        container.innerHTML = '<div class="no-data">Keine Symbole abonniert</div>';
                        return;
                    }

                    container.innerHTML = data.symbols.map(symbol => {
                        const prevPrices = previousPrices[symbol.symbol] || {};

                        // Normalize to fixed precision for comparison
                        const currentBid = parseFloat(symbol.bid).toFixed(5);
                        const currentAsk = parseFloat(symbol.ask).toFixed(5);
                        const prevBid = prevPrices.bid ? parseFloat(prevPrices.bid).toFixed(5) : null;
                        const prevAsk = prevPrices.ask ? parseFloat(prevPrices.ask).toFixed(5) : null;

                        const bidChanged = prevBid && prevBid !== currentBid;
                        const askChanged = prevAsk && prevAsk !== currentAsk;

                        // Store current prices for next comparison
                        previousPrices[symbol.symbol] = {
                            bid: symbol.bid,
                            ask: symbol.ask
                        };

                        // Trend arrows helper
                        const getTrendArrow = (trend) => {
                            if (trend === 'up') return '‚ñ≤';
                            if (trend === 'down') return '‚ñº';
                            return '‚óè';
                        };

                        const trends = symbol.trends || {};

                        return `
                        <div class="symbol-item" data-symbol="${symbol.symbol}">
                            <div class="symbol-name">
                                ${symbol.symbol}
                                ${!symbol.tradeable ? '<span style="margin-left: 8px; color: #f44336; font-size: 0.9em;" title="Au√üerhalb der Handelszeiten">üîí</span>' : ''}
                            </div>
                            <div class="symbol-main">
                                <div class="price-container">
                                    <div class="price-item">
                                        <span class="price-label">Bid</span>
                                        <span class="price-value price-bid ${bidChanged ? 'price-pulse' : ''}">${symbol.bid || '-'}</span>
                                    </div>
                                    <div class="price-item">
                                        <span class="price-label">Ask</span>
                                        <span class="price-value price-ask ${askChanged ? 'price-pulse' : ''}">${symbol.ask || '-'}</span>
                                    </div>
                                </div>
                                <div class="tick-info">
                                    ${symbol.tick_count} Ticks | Letzter Tick: ${symbol.last_tick || '-'}
                                </div>
                            </div>
                            <div class="trends-container">
                                <div class="trend-item">
                                    <span class="trend-label">M5</span>
                                    <span class="trend-arrow trend-${trends.M5 || 'neutral'}">${getTrendArrow(trends.M5)}</span>
                                </div>
                                <div class="trend-item">
                                    <span class="trend-label">M15</span>
                                    <span class="trend-arrow trend-${trends.M15 || 'neutral'}">${getTrendArrow(trends.M15)}</span>
                                </div>
                                <div class="trend-item">
                                    <span class="trend-label">H1</span>
                                    <span class="trend-arrow trend-${trends.H1 || 'neutral'}">${getTrendArrow(trends.H1)}</span>
                                </div>
                                <div class="trend-item">
                                    <span class="trend-label">H4</span>
                                    <span class="trend-arrow trend-${trends.H4 || 'neutral'}">${getTrendArrow(trends.H4)}</span>
                                </div>
                            </div>
                        </div>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('Error fetching symbols:', error);
            }
        }


        // Load confidence setting from localStorage
        const savedConfidence = localStorage.getItem('signal_confidence_threshold');
        if (savedConfidence) {
            document.getElementById('signal-confidence-slider').value = savedConfidence;
            document.getElementById('confidence-value').textContent = savedConfidence;
        }

        // Handle confidence slider changes
        const confidenceSlider = document.getElementById('signal-confidence-slider');
        confidenceSlider.addEventListener('input', function() {
            const value = this.value;
            document.getElementById('confidence-value').textContent = value;
        });

        confidenceSlider.addEventListener('change', function() {
            const value = this.value;
            // Save to localStorage
            localStorage.setItem('signal_confidence_threshold', value);
            // Update signals immediately
            updateSignals();
        });

        // AutoTrade checkbox and slider handling
        const autotradeEnabled = document.getElementById('autotrade-enabled');
        const autotradeSettings = document.getElementById('autotrade-settings');
        const autotradeSlider = document.getElementById('autotrade-confidence-slider');
        const autotradeValue = document.getElementById('autotrade-confidence-value');

        // Load AutoTrade status from server (not localStorage!)
        async function loadAutoTradeStatus() {
            try {
                const apiBase = window.location.protocol + '//' + window.location.hostname + ':9900';
                const response = await fetch(apiBase + '/api/auto-trade/status');
                const data = await response.json();

                if (response.ok) {
                    // Update UI based on server status
                    autotradeEnabled.checked = data.enabled;
                    autotradeSlider.value = data.min_confidence;
                    autotradeValue.textContent = data.min_confidence;

                    // Sync localStorage with server state
                    localStorage.setItem('autotrade_enabled', data.enabled);
                    localStorage.setItem('autotrade_confidence', data.min_confidence);

                    if (data.enabled) {
                        autotradeSettings.style.display = 'block';
                    }

                    console.log('‚úÖ Auto-Trade status loaded from server:', data);
                } else {
                    console.error('‚ùå Failed to load auto-trade status:', data);
                    // Fallback to localStorage if server fails
                    const savedAutotradeEnabled = localStorage.getItem('autotrade_enabled') === 'true';
                    const savedAutotradeConfidence = localStorage.getItem('autotrade_confidence') || '40';
                    autotradeEnabled.checked = savedAutotradeEnabled;
                    autotradeSlider.value = savedAutotradeConfidence;
                    autotradeValue.textContent = savedAutotradeConfidence;
                    if (savedAutotradeEnabled) {
                        autotradeSettings.style.display = 'block';
                    }
                }
            } catch (error) {
                console.error('‚ùå Error loading auto-trade status:', error);
                // Fallback to localStorage if server fails
                const savedAutotradeEnabled = localStorage.getItem('autotrade_enabled') === 'true';
                const savedAutotradeConfidence = localStorage.getItem('autotrade_confidence') || '40';
                autotradeEnabled.checked = savedAutotradeEnabled;
                autotradeSlider.value = savedAutotradeConfidence;
                autotradeValue.textContent = savedAutotradeConfidence;
                if (savedAutotradeEnabled) {
                    autotradeSettings.style.display = 'block';
                }
            }
        }

        // Load status from server on page load
        loadAutoTradeStatus();

        // Toggle AutoTrade settings visibility
        autotradeEnabled.addEventListener('change', function() {
            const isEnabled = this.checked;
            localStorage.setItem('autotrade_enabled', isEnabled);

            if (isEnabled) {
                // Show settings and sync confidence slider value
                autotradeSettings.style.display = 'block';
                const mainConfidence = document.getElementById('signal-confidence-slider').value;
                autotradeSlider.value = mainConfidence;
                autotradeValue.textContent = mainConfidence;
                localStorage.setItem('autotrade_confidence', mainConfidence);
            } else {
                // Hide settings
                autotradeSettings.style.display = 'none';
            }
        });

        // Handle AutoTrade confidence slider changes
        // Track the initial value when user starts dragging
        let autotradeInitialValue = autotradeSlider.value;

        autotradeSlider.addEventListener('mousedown', function() {
            autotradeInitialValue = this.value;
        });

        autotradeSlider.addEventListener('touchstart', function() {
            autotradeInitialValue = this.value;
        });

        autotradeSlider.addEventListener('input', function() {
            const value = this.value;
            autotradeValue.textContent = value;
        });

        autotradeSlider.addEventListener('change', function() {
            const value = this.value;

            // If auto-trade is enabled and confidence is being LOWERED past initial value, ask for confirmation
            if (autotradeEnabled.checked && parseInt(value) < parseInt(autotradeInitialValue)) {
                const confirmed = confirm(
                    `‚ö†Ô∏è Warning: You are lowering the Auto-Trade confidence from ${autotradeInitialValue}% to ${value}%.\n\n` +
                    `This means MORE signals will be auto-traded (potentially riskier signals).\n\n` +
                    `Are you sure you want to continue?`
                );

                if (!confirmed) {
                    // Revert slider to initial value (before drag started)
                    this.value = autotradeInitialValue;
                    autotradeValue.textContent = autotradeInitialValue;
                    return;
                }
            }

            // Update initial value for next drag
            autotradeInitialValue = value;
            localStorage.setItem('autotrade_confidence', value);

            // If auto-trade is enabled, update the confidence setting on the server
            if (autotradeEnabled.checked) {
                enableAutoTrade(value);
            }
        });

        // Auto-trade checkbox event listener
        autotradeEnabled.addEventListener('change', async function() {
            const isEnabled = this.checked;
            const minConfidence = autotradeSlider.value;
            localStorage.setItem('autotrade_enabled', isEnabled);

            if (isEnabled) {
                await enableAutoTrade(minConfidence);
            } else {
                await disableAutoTrade();
            }
        });

        // Enable auto-trade with confidence threshold
        async function enableAutoTrade(minConfidence) {
            try {
                const apiBase = window.location.protocol + '//' + window.location.hostname + ':9900';
                const response = await fetch(apiBase + '/api/auto-trade/enable', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ min_confidence: parseInt(minConfidence) })
                });
                const data = await response.json();
                if (response.ok) {
                    console.log('‚úÖ Auto-Trade enabled:', data.message);
                } else {
                    console.error('‚ùå Failed to enable auto-trade:', data.message);
                    autotradeEnabled.checked = false;
                }
            } catch (error) {
                console.error('‚ùå Error enabling auto-trade:', error);
                autotradeEnabled.checked = false;
            }
        }

        // Disable auto-trade
        async function disableAutoTrade() {
            try {
                const apiBase = window.location.protocol + '//' + window.location.hostname + ':9900';
                const response = await fetch(apiBase + '/api/auto-trade/disable', {
                    method: 'POST'
                });
                const data = await response.json();
                if (response.ok) {
                    console.log('‚úÖ Auto-Trade disabled:', data.message);
                } else {
                    console.error('‚ùå Failed to disable auto-trade:', data.message);
                }
            } catch (error) {
                console.error('‚ùå Error disabling auto-trade:', error);
            }
        }

        // Trade history pagination (must be declared early for WebSocket usage)
        let currentPage = 1;

        // Initial load
        updateAccountStatus();
        updateSymbols();
        updateInfoBar();
        updateSignals();

        // WebSocket event handlers for real-time updates
        socket.on('connected', (data) => {
            console.log('üü¢ WebSocket connected successfully:', data);
        });

        socket.on('connect', () => {
            console.log('üü¢ WebSocket connect event fired');
        });

        socket.on('disconnect', () => {
            console.warn('üî¥ WebSocket disconnected');
        });

        socket.on('connect_error', (error) => {
            console.error('üî¥ WebSocket connection error:', error);
        });

        socket.on('account_update', (data) => {
            // Update account info immediately via WebSocket
            document.getElementById('account-number').textContent = data.number;
            document.getElementById('balance').textContent = '‚Ç¨' + (data.balance || 0).toFixed(2);
            document.getElementById('equity').textContent = '‚Ç¨' + (data.equity || 0).toFixed(2);
            document.getElementById('margin').textContent = '‚Ç¨' + (data.margin || 0).toFixed(2);
            document.getElementById('free-margin').textContent = '‚Ç¨' + (data.free_margin || 0).toFixed(2);
        });

        socket.on('price_update', (data) => {
            // Update individual symbol prices in real-time
            const symbolItem = document.querySelector(`.symbol-item[data-symbol="${data.symbol}"]`);
            if (symbolItem) {
                const bidElement = symbolItem.querySelector('.price-bid');
                const askElement = symbolItem.querySelector('.price-ask');

                // Check if price ACTUALLY changed (compare numeric values, not strings)
                const newBid = parseFloat(data.bid).toFixed(5);
                const newAsk = parseFloat(data.ask).toFixed(5);
                const oldBid = bidElement ? bidElement.textContent.trim() : null;
                const oldAsk = askElement ? askElement.textContent.trim() : null;

                if (bidElement && oldBid !== newBid) {
                    bidElement.textContent = newBid;
                    bidElement.classList.add('price-pulse');
                    setTimeout(() => bidElement.classList.remove('price-pulse'), 400);
                }

                if (askElement && oldAsk !== newAsk) {
                    askElement.textContent = newAsk;
                    askElement.classList.add('price-pulse');
                    setTimeout(() => askElement.classList.remove('price-pulse'), 400);
                }
            }
        });

        socket.on('profit_update', (data) => {
            // Update profit values in real-time
            updateProfitValue('profit-today', data.today);
            updateProfitValue('profit-week', data.week);
            updateProfitValue('profit-month', data.month);
            updateProfitValue('profit-year', data.year);
        });

        // Real-time position updates via WebSocket
        // Track previous position data for change detection
        let previousPositions = {};
        let lastUpdateTime = 0;
        const UPDATE_THROTTLE_MS = 500; // Only update UI every 500ms max

        socket.on('positions_update', (data) => {
            // Throttle UI updates to reduce CPU usage
            const now = Date.now();
            if (now - lastUpdateTime < UPDATE_THROTTLE_MS) {
                return; // Skip this update
            }
            lastUpdateTime = now;

            if (data && data.positions) {
                const positions = data.positions;
                const currentTickets = new Set(positions.map(p => p.ticket));
                const previousTickets = new Set(Object.keys(previousPositions).map(Number));

                // Detect closed positions (tickets that were in previousPositions but not in current positions)
                const closedTickets = [...previousTickets].filter(ticket => !currentTickets.has(ticket));
                if (closedTickets.length > 0) {
                    console.log('üîî Trade(s) closed:', closedTickets);
                    // Refresh trade history when positions are closed
                    setTimeout(() => loadTradeHistory(currentPage), 1000); // Delay 1s to ensure DB is updated
                }

                document.getElementById('open-trades-count').textContent = positions.length;

                if (positions.length === 0) {
                    document.getElementById('open-trades-list').innerHTML = '<div style="text-align: center; color: #888; padding: 20px;">No open positions</div>';
                    previousPositions = {};
                } else {
                    // Sort positions by profit (descending - highest profit first)
                    positions.sort((a, b) => b.pnl - a.pnl);
                    
                    // Check which positions have changed
                    const changedTickets = new Set();
                    positions.forEach(pos => {
                        const prev = previousPositions[pos.ticket];
                        if (prev && (
                            prev.current_price !== pos.current_price ||
                            prev.pnl !== pos.pnl
                        )) {
                            changedTickets.add(pos.ticket);
                        }
                        // Store current data for next comparison
                        previousPositions[pos.ticket] = {
                            current_price: pos.current_price,
                            pnl: pos.pnl
                        };
                    });

                    const gridHTML = '<div class="trades-grid">' + positions.map(pos => renderOpenTradeCard(pos, changedTickets.has(pos.ticket))).join('') + '</div>';
                    document.getElementById('open-trades-list').innerHTML = gridHTML;
                }

                // Update last update timestamp
                const now = new Date();
                const timeStr = now.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                const timestampEl = document.getElementById('positions-last-update');
                if (timestampEl) {
                    timestampEl.textContent = timeStr;
                    timestampEl.classList.add('price-pulse');
                    setTimeout(() => timestampEl.classList.remove('price-pulse'), 400);
                }
            } else {
                console.warn('üî¥ No positions data in WebSocket message');
            }
        });

        // Store current signals for comparison
        let currentSignals = {};

        // Track which signals have been auto-traded (persist in localStorage)
        let autoTradedSignals = new Set(JSON.parse(localStorage.getItem('autoTradedSignals') || '[]'));

        // Signal timing variables (must be declared before updateSignals)
        let signalInterval = 120;  // 2 minutes = 120 seconds (optimized for H1/H4)

        // Calculate seconds until next interval boundary
        function getSecondsToNextInterval(interval) {
            const now = new Date();
            const seconds = now.getSeconds();
            const minutes = now.getMinutes();
            const totalSeconds = minutes * 60 + seconds;
            const remainder = totalSeconds % interval;
            return remainder === 0 ? interval : interval - remainder;
        }

        let signalCountdown = getSecondsToNextInterval(signalInterval);

        // Update signals
        async function updateSignals() {
            try {
                const timeframe = document.getElementById('signal-timeframe').value;
                const confidence = document.getElementById('signal-confidence-slider').value;
                const type = document.getElementById('signal-type').value;

                const params = new URLSearchParams();
                if (timeframe) params.append('timeframe', timeframe);
                if (confidence) params.append('confidence', confidence);
                if (type) params.append('type', type);

                const response = await fetch(`/api/signals?${params.toString()}`);
                const data = await response.json();

                const container = document.getElementById('signals-list');
                if (!data.signals || data.signals.length === 0) {
                    container.innerHTML = '<div style="padding: 20px; text-align: center; color: #888;">Keine Signale gefunden</div>';
                    currentSignals = {};
                    return;
                }

                // Sort signals by confidence (strong to weak), then by timeframe (higher = better)
                const timeframeRank = { 'M1': 1, 'M5': 5, 'M15': 15, 'M30': 30, 'H1': 60, 'H4': 240, 'D1': 1440, 'W1': 10080, 'MN1': 43200 };
                data.signals.sort((a, b) => {
                    // First sort by confidence
                    if (b.confidence !== a.confidence) {
                        return b.confidence - a.confidence;
                    }
                    // If confidence is equal, sort by timeframe (higher timeframe = better)
                    return (timeframeRank[b.timeframe] || 0) - (timeframeRank[a.timeframe] || 0);
                });

                // Build map of new signals
                const newSignals = {};
                data.signals.forEach(sig => {
                    newSignals[sig.id] = sig;
                });

                // Remove signals that no longer exist or are no longer tradeable
                Object.keys(currentSignals).forEach(id => {
                    const newSignal = newSignals[id];
                    if (!newSignal || newSignal.tradeable === false) {
                        const elem = document.querySelector(`[data-signal-id="${id}"]`);
                        if (elem) elem.remove();
                        delete currentSignals[id];
                        // Also remove from autoTradedSignals to keep the list clean
                        autoTradedSignals.delete(parseInt(id));
                    }
                });

                // Clean up autoTradedSignals - remove IDs older than 24 hours
                const currentSignalIds = new Set(data.signals.map(s => s.id));
                autoTradedSignals = new Set([...autoTradedSignals].filter(id =>
                    currentSignalIds.has(id) || newSignals[id]
                ));
                localStorage.setItem('autoTradedSignals', JSON.stringify([...autoTradedSignals]));

                // Update or add signals
                data.signals.forEach(signal => {
                    // Skip non-tradeable symbols (market closed)
                    if (signal.tradeable === false) {
                        return;
                    }

                    const existing = currentSignals[signal.id];
                    const elem = document.querySelector(`[data-signal-id="${signal.id}"]`);

                    // Check if signal changed (compare as floats to handle decimal precision)
                    const changed = !existing ||
                        parseFloat(existing.confidence) !== parseFloat(signal.confidence) ||
                        parseFloat(existing.entry_price) !== parseFloat(signal.entry_price) ||
                        parseFloat(existing.sl_price) !== parseFloat(signal.sl_price) ||
                        parseFloat(existing.tp_price) !== parseFloat(signal.tp_price) ||
                        existing.signal_type !== signal.signal_type;

                    if (changed) {
                        // Log updates for debugging
                        if (existing) {
                            console.log(`Signal ${signal.symbol} ${signal.timeframe} updated:`, {
                                entry: `${existing.entry_price} ‚Üí ${signal.entry_price}`,
                                sl: `${existing.sl_price} ‚Üí ${signal.sl_price}`,
                                tp: `${existing.tp_price} ‚Üí ${signal.tp_price}`,
                                confidence: `${existing.confidence} ‚Üí ${signal.confidence}`
                            });
                        }
                        const confidenceClass = signal.confidence >= 80 ? 'high' :
                                              signal.confidence >= 60 ? 'medium' : 'low';
                        const signalClass = signal.signal_type.toLowerCase();

                        // Calculate dynamic trailing stop in pips
                        const calculateDynamicTS = (entry, sl, timeframe) => {
                            const slDistance = Math.abs(entry - sl);
                            // Convert to pips (assuming 5-digit pricing for forex)
                            const slPips = slDistance * 10000;

                            // Timeframe multipliers
                            const timeframeMultipliers = {
                                'M5': 0.3,   // 30% of SL distance
                                'M15': 0.4,  // 40% of SL distance
                                'H1': 0.5,   // 50% of SL distance
                                'H4': 0.6,   // 60% of SL distance
                                'D1': 0.7    // 70% of SL distance
                            };

                            const multiplier = timeframeMultipliers[timeframe] || 0.5;
                            const tsPips = Math.round(slPips * multiplier);

                            // Min 5 pips, max 200 pips
                            return Math.max(5, Math.min(200, tsPips));
                        };

                        const dynamicTS = calculateDynamicTS(signal.entry_price, signal.sl_price, signal.timeframe);

                        const html = `
                            <div class="signal-item signal-${signalClass}" data-signal-id="${signal.id}">
                                <!-- ROW 1: Headers -->
                                <!-- Cell 1-2: Empty -->
                                <div style="grid-column: 1 / 3; grid-row: 1;"></div>

                                <!-- Cell 3: Header -->
                                <div style="grid-column: 3; grid-row: 1; font-size: 0.7em; color: #999; text-align: center;">Conf</div>

                                <!-- Cell 4: Header -->
                                <div style="grid-column: 4; grid-row: 1; font-size: 0.7em; color: #999; text-align: center;">Dir</div>

                                <!-- Cell 5: Header -->
                                <div style="grid-column: 5; grid-row: 1; font-size: 0.7em; color: #999; text-align: center;">Entry</div>

                                <!-- Cell 6: Header -->
                                <div style="grid-column: 6; grid-row: 1; font-size: 0.7em; color: #999; text-align: center;">SL</div>

                                <!-- Cell 7: Header -->
                                <div style="grid-column: 7; grid-row: 1; font-size: 0.7em; color: #999; text-align: center;">TP</div>

                                <!-- Cell 8: Header -->
                                <div style="grid-column: 8; grid-row: 1; font-size: 0.7em; color: #999; text-align: center;">Lot</div>

                                <!-- Cell 9: Header -->
                                <div style="grid-column: 9; grid-row: 1; font-size: 0.7em; color: #999; text-align: center;">Risk %</div>

                                <!-- Cell 10: Header -->
                                <div style="grid-column: 10; grid-row: 1; font-size: 0.7em; color: #999; text-align: center;">TS Pips</div>

                                <!-- Cell 11-12: Empty -->
                                <div style="grid-column: 11 / 13; grid-row: 1;"></div>

                                <!-- ROW 2: Values -->
                                <!-- Cell 1: Symbol Name -->
                                <div style="grid-column: 1; grid-row: 2; font-size: 1em; color: #fff; font-weight: bold; display: flex; align-items: center;">
                                    ${signal.symbol}
                                </div>

                                <!-- Cell 2: TimeFrame -->
                                <div style="grid-column: 2; grid-row: 2; font-size: 0.85em; color: #e0e0e0; font-weight: 600; text-align: center;">
                                    ${signal.timeframe}
                                </div>

                                <!-- Cell 3: Confidence Value -->
                                <div style="grid-column: 3; grid-row: 2; text-align: center;">
                                    <span class="signal-confidence confidence-${confidenceClass}">${Math.round(signal.confidence)}%</span>
                                </div>

                                <!-- Cell 4: Direction Value -->
                                <div style="grid-column: 4; grid-row: 2; text-align: center;">
                                    <span class="signal-type ${signalClass}">${signal.signal_type}</span>
                                </div>

                                <!-- Cell 5: Entry Value -->
                                <div class="signal-price-value" style="grid-column: 5; grid-row: 2; font-size: 0.85em; color: #e0e0e0; font-weight: 600; font-family: 'Courier New', monospace; text-align: center;">
                                    ${signal.entry_price ? signal.entry_price.toFixed(5) : '-'}
                                </div>

                                <!-- Cell 6: SL Value -->
                                <div class="signal-price-value" style="grid-column: 6; grid-row: 2; font-size: 0.85em; color: #e0e0e0; font-weight: 600; font-family: 'Courier New', monospace; text-align: center;">
                                    ${signal.sl_price ? signal.sl_price.toFixed(5) : '-'}
                                </div>

                                <!-- Cell 7: TP Value -->
                                <div class="signal-price-value" style="grid-column: 7; grid-row: 2; font-size: 0.85em; color: #e0e0e0; font-weight: 600; font-family: 'Courier New', monospace; text-align: center;">
                                    ${signal.tp_price ? signal.tp_price.toFixed(5) : '-'}
                                </div>

                                <!-- Cell 8: LOT Value -->
                                <div class="signal-price-value" style="grid-column: 8; grid-row: 2; font-size: 0.85em; color: #e0e0e0; font-weight: 600; font-family: 'Courier New', monospace; text-align: center;" id="lot-${signal.id}">
                                    0.01
                                </div>

                                <!-- Cell 9: Risk Value -->
                                <div class="signal-price-value" style="grid-column: 9; grid-row: 2; font-size: 0.85em; color: #e0e0e0; font-weight: 600; font-family: 'Courier New', monospace; text-align: center;" id="risk-${signal.id}">
                                    1%
                                </div>

                                <!-- Cell 10: TS Pips Value -->
                                <div style="grid-column: 10; grid-row: 2; text-align: center;">
                                    <input type="number" id="ts-pips-${signal.id}" value="${dynamicTS}" min="1" max="1000" step="1"
                                           style="width: 100%; max-width: 60px; background: #2a2a2a; border: 1px solid #444; color: #fff; padding: 2px 5px; border-radius: 3px; text-align: center;">
                                </div>

                                <!-- Cell 11: Empty -->
                                <div style="grid-column: 11; grid-row: 2;"></div>

                                <!-- ROW 3: Signals and Patterns -->
                                <div style="grid-column: 1; grid-row: 3;"></div>
                                <div style="grid-column: 2 / 12; grid-row: 3; text-align: center; font-size: 0.75em;">
                                    ${(() => {
                                        try {
                                            const indicators = [];
                                            if (signal.indicators_used) {
                                                if (Array.isArray(signal.indicators_used)) {
                                                    indicators.push(...signal.indicators_used);
                                                } else if (typeof signal.indicators_used === 'object') {
                                                    indicators.push(...Object.keys(signal.indicators_used).filter(k => signal.indicators_used[k]));
                                                }
                                            }
                                            const patterns = Array.isArray(signal.patterns_detected) ? signal.patterns_detected : [];

                                            let html = '';
                                            if (indicators.length > 0) {
                                                html += '<span style="color: #4CAF50; font-weight: 600;">Indikatoren: </span>';
                                                html += indicators.map(ind => {
                                                    const escaped = String(ind).replace(/'/g, "\\'").replace(/"/g, '&quot;');
                                                    return `<span class="clickable-indicator" onclick="showExplanation('${escaped}', 'indicator')" style="color: #4CAF50; cursor: pointer; text-decoration: underline; margin: 0 4px;">${ind}</span>`;
                                                }).join(' ‚Ä¢ ');
                                            }
                                            if (patterns.length > 0) {
                                                if (html) html += ' | ';
                                                html += '<span style="color: #FFA726; font-weight: 600;">Muster: </span>';
                                                html += patterns.map(pat => {
                                                    const escaped = String(pat).replace(/'/g, "\\'").replace(/"/g, '&quot;').replace(/`/g, '\\`');
                                                    return `<span class="clickable-pattern" onclick="showExplanation('${escaped}', 'pattern')" style="color: #FFA726; cursor: pointer; text-decoration: underline; margin: 0 4px;">${pat}</span>`;
                                                }).join(' ‚Ä¢ ');
                                            }
                                            return html;
                                        } catch (e) {
                                            console.error('Error rendering indicators/patterns:', e, signal);
                                            return '<span style="color: #888;">-</span>';
                                        }
                                    })()}
                                </div>

                                <!-- Cell 12: Button spanning all rows (defined last to ensure proper z-index) -->
                                <div style="grid-column: 12; grid-row: 1 / 4; display: flex; align-items: center; justify-content: center;">
                                    <button class="trade-btn trade-btn-${signalClass}" onclick="executeTrade(event, ${signal.id}, '${signal.symbol}', '${signal.signal_type}', ${signal.entry_price}, ${signal.sl_price}, ${signal.tp_price})"
                                            style="width: 90%; height: 95%; padding: 0; font-size: 0.75em; white-space: nowrap; display: flex; align-items: center; justify-content: center;">
                                        ${signal.signal_type}
                                    </button>
                                </div>
                            </div>
                        `;

                        if (elem) {
                            // Update existing signal with individual field animations
                            const oldEntry = existing ? parseFloat(existing.entry_price) : null;
                            const oldSL = existing ? parseFloat(existing.sl_price) : null;
                            const oldTP = existing ? parseFloat(existing.tp_price) : null;
                            const oldConfidence = existing ? parseFloat(existing.confidence) : null;

                            elem.outerHTML = html;

                            // Pulse individual fields that changed
                            setTimeout(() => {
                                const updatedElem = document.querySelector(`[data-signal-id="${signal.id}"]`);
                                if (updatedElem) {
                                    const priceItems = updatedElem.querySelectorAll('.signal-price-value');
                                    const confidenceElem = updatedElem.querySelector('.signal-confidence');

                                    // Check and pulse Confidence
                                    if (oldConfidence !== null && oldConfidence !== parseFloat(signal.confidence) && confidenceElem) {
                                        confidenceElem.classList.add('price-pulse');
                                        setTimeout(() => confidenceElem.classList.remove('price-pulse'), 400);
                                    }

                                    // Check and pulse Entry (index 0)
                                    if (oldEntry !== null && oldEntry !== parseFloat(signal.entry_price) && priceItems[0]) {
                                        priceItems[0].classList.add('price-pulse');
                                        setTimeout(() => priceItems[0].classList.remove('price-pulse'), 400);
                                    }

                                    // Check and pulse SL (index 1)
                                    if (oldSL !== null && oldSL !== parseFloat(signal.sl_price) && priceItems[1]) {
                                        priceItems[1].classList.add('price-pulse');
                                        setTimeout(() => priceItems[1].classList.remove('price-pulse'), 400);
                                    }

                                    // Check and pulse TP (index 2)
                                    if (oldTP !== null && oldTP !== parseFloat(signal.tp_price) && priceItems[2]) {
                                        priceItems[2].classList.add('price-pulse');
                                        setTimeout(() => priceItems[2].classList.remove('price-pulse'), 400);
                                    }

                                    // Note: Lot (index 3) and Risk (index 4) don't change from signals,
                                    // they are calculated client-side, so we don't pulse them
                                }
                            }, 10);
                        } else {
                            // Add new signal
                            container.insertAdjacentHTML('beforeend', html);
                        }

                        currentSignals[signal.id] = signal;

                        // Check if AutoTrade should execute this signal
                        if (!existing && autotradeEnabled.checked && !autoTradedSignals.has(signal.id)) {
                            const autotradeConfidence = parseFloat(autotradeSlider.value);
                            if (signal.confidence >= autotradeConfidence) {
                                console.log(`AutoTrade: Executing ${signal.signal_type} ${signal.symbol} (confidence: ${signal.confidence}%)`);
                                // Mark signal as auto-traded immediately to prevent duplicates
                                autoTradedSignals.add(signal.id);
                                localStorage.setItem('autoTradedSignals', JSON.stringify([...autoTradedSignals]));

                                // Execute trade automatically (delay slightly to ensure DOM is updated)
                                setTimeout(() => {
                                    autoExecuteTrade(signal);
                                }, 100);
                            }
                        }
                    }
                });

                // Update volatility level display
                if (data.volatility && data.interval) {
                    const volatilityEl = document.getElementById('volatility-level');
                    if (volatilityEl) {
                        let volatilityEmoji = '';
                        let volatilityColor = '#4CAF50';

                        if (data.volatility === 'high') {
                            volatilityEmoji = 'üî•';
                            volatilityColor = '#ff9800';
                        } else if (data.volatility === 'low') {
                            volatilityEmoji = 'üò¥';
                            volatilityColor = '#2196F3';
                        } else {
                            volatilityEmoji = 'üìä';
                            volatilityColor = '#4CAF50';
                        }

                        volatilityEl.innerHTML = volatilityEmoji;
                        volatilityEl.style.color = volatilityColor;
                    }

                    // Update interval to match server and resync to clock if it changed
                    if (signalInterval !== data.interval) {
                        signalInterval = data.interval;
                        signalCountdown = getSecondsToNextInterval(signalInterval);
                    }
                }
            } catch (error) {
                console.error('Error fetching signals:', error);
                console.error('Error stack:', error.stack);
                document.getElementById('signals-list').innerHTML =
                    `<div style="padding: 20px; text-align: center; color: #f44336;">
                        Fehler beim Laden der Signale<br>
                        <small style="color: #888; font-size: 0.8em;">${error.message}</small>
                    </div>`;
            }
        }

        // Execute trade from signal
        async function executeTrade(event, signalId, symbol, orderType, entry, sl, tp) {
            const lotSize = parseFloat(document.getElementById(`lot-${signalId}`).textContent);

            // No confirmation dialog - execute directly
            const btn = event.currentTarget;
            btn.disabled = true;
            btn.textContent = '‚è≥ Trade wird ge√∂ffnet...';

            try {
                const response = await fetch('/api/open_trade', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        symbol: symbol,
                        order_type: orderType,
                        volume: lotSize,
                        sl: sl,
                        tp: tp,
                        comment: `Signal #${signalId}`
                    })
                });

                const data = await response.json();

                if (data.status === 'success') {
                    btn.textContent = `‚úÖ Trade #${data.command_id} er√∂ffnet!`;
                    btn.style.background = '#4CAF50';
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.textContent = `üìà ${orderType} Trade √∂ffnen`;
                        btn.style.background = '';
                    }, 3000);
                } else {
                    btn.textContent = '‚ùå Fehler: ' + data.message;
                    btn.style.background = '#f44336';
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.textContent = `üìà ${orderType} Trade √∂ffnen`;
                        btn.style.background = '';
                    }, 3000);
                }
            } catch (error) {
                console.error('Trade execution error:', error);
                btn.textContent = '‚ùå Verbindungsfehler';
                setTimeout(() => {
                    btn.disabled = false;
                    btn.textContent = `üìà ${orderType} Trade √∂ffnen`;
                    btn.style.background = '';
                }, 3000);
            }
        }

        // Auto-execute trade for AutoTrade feature
        async function autoExecuteTrade(signal) {
            const lotSize = parseFloat(document.getElementById(`lot-${signal.id}`)?.textContent || '0.01');
            const trailingStopEnabled = document.getElementById('autotrade-trailing-stop').checked;
            const trailingStopPips = parseFloat(document.getElementById(`ts-pips-${signal.id}`)?.value || '10');

            console.log(`AutoTrade: Opening ${signal.signal_type} trade for ${signal.symbol}` +
                        (trailingStopEnabled ? ` with TS ${trailingStopPips} pips` : ''));

            try {
                const tradeData = {
                    symbol: signal.symbol,
                    order_type: signal.signal_type,
                    volume: lotSize,
                    sl: signal.sl_price,
                    tp: signal.tp_price,
                    comment: `AutoTrade #${signal.id} ${signal.timeframe} (${Math.round(signal.confidence)}%)`,
                    signal_id: signal.id,
                    timeframe: signal.timeframe
                };

                // Add trailing stop if enabled
                if (trailingStopEnabled) {
                    tradeData.trailing_stop = trailingStopPips;
                }

                const response = await fetch('/api/open_trade', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(tradeData)
                });

                const data = await response.json();

                if (data.status === 'success') {
                    console.log(`AutoTrade: Successfully opened trade #${data.command_id} for ${signal.symbol}`);
                } else {
                    console.error(`AutoTrade: Failed to open trade for ${signal.symbol}: ${data.message}`);
                }
            } catch (error) {
                console.error(`AutoTrade: Error executing trade for ${signal.symbol}:`, error);
            }
        }

        // Calculate lot size based on risk percentage
        async function calculateLotSize(signalId, symbol, entry, sl, riskPercent) {
            try {
                const response = await fetch('/api/dashboard/status');
                const data = await response.json();

                const balance = data.balance || 1000;
                const riskAmount = balance * (riskPercent / 100);
                const slDistance = Math.abs(entry - sl);

                // Simple lot calculation (needs refinement for different symbols)
                const pointValue = 10; // $10 per lot per point for most forex pairs
                const lotSize = riskAmount / (slDistance * pointValue);

                return Math.max(0.01, Math.round(lotSize * 100) / 100); // Min 0.01 lot
            } catch (error) {
                return 0.01; // Default fallback
            }
        }

        // Update info bar every second (for time display)
        setInterval(() => {
            updateInfoBar();
        }, 1000);

        // Poll auto-trade status every 10 seconds to keep dashboard in sync
        setInterval(() => {
            loadAutoTradeStatus();
        }, 10000);

        // Load symbol performance every 15 seconds
        async function loadSymbolPerformance() {
            try {
                const apiBase = window.location.protocol + '//' + window.location.hostname + ':9900';
                const response = await fetch(apiBase + '/api/performance/symbols');
                const data = await response.json();

                if (response.ok && data.symbols) {
                    const tbody = document.getElementById('symbol-performance-list');
                    if (!tbody) return;

                    if (data.symbols.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 20px; color: #888;">No performance data yet</td></tr>';
                        return;
                    }

                    tbody.innerHTML = data.symbols.map(s => {
                        const statusIcon = s.status === 'active' ? '‚úÖ' : s.status === 'disabled' ? '‚õî' : '‚ö†Ô∏è';
                        const statusColor = s.status === 'active' ? '#4CAF50' : s.status === 'disabled' ? '#f44336' : '#ff9800';
                        const profitColor = s.live_profit > 0 ? '#4CAF50' : s.live_profit < 0 ? '#f44336' : '#888';
                        const winRateColor = s.live_win_rate >= 70 ? '#4CAF50' : s.live_win_rate >= 50 ? '#ff9800' : '#f44336';

                        return `
                            <tr style="border-bottom: 1px solid #333;">
                                <td style="padding: 10px; font-weight: bold;">${s.symbol}</td>
                                <td style="padding: 10px;">
                                    <span style="color: ${statusColor};">${statusIcon} ${s.status.toUpperCase()}</span>
                                </td>
                                <td style="padding: 10px; text-align: right;">${s.live_trades || 0}</td>
                                <td style="padding: 10px; text-align: right; color: ${winRateColor}; font-weight: bold;">
                                    ${s.live_win_rate ? s.live_win_rate.toFixed(1) : 0}%
                                </td>
                                <td style="padding: 10px; text-align: right; color: ${profitColor}; font-weight: bold;">
                                    ‚Ç¨${s.live_profit ? s.live_profit.toFixed(2) : '0.00'}
                                </td>
                                <td style="padding: 10px; font-size: 0.85em; color: #888;">
                                    ${s.auto_disabled_reason || '-'}
                                </td>
                            </tr>
                        `;
                    }).join('');
                }
            } catch (error) {
                console.error('‚ùå Error loading symbol performance:', error);
            }
        }

        // Initial load and periodic refresh
        loadSymbolPerformance();
        setInterval(loadSymbolPerformance, 15000);

        // Load AI Decision Log
        async function loadAIDecisionLog() {
            try {
                const filter = document.getElementById('decision-type-filter').value;

                let url = '/api/ai-decisions?limit=30';
                if (filter) {
                    url += '&type=' + filter;
                }

                const response = await fetch(url);
                const data = await response.json();

                if (response.ok && data.decisions) {
                    renderDecisions(data.decisions);
                } else {
                    document.getElementById('ai-decision-log-container').innerHTML =
                        '<div style="text-align: center; padding: 20px; color: #f44336;">Error loading decisions</div>';
                }

                // Load action-required count
                const actionResponse = await fetch('/api/ai-decisions/action-required');
                const actionData = await actionResponse.json();

                if (actionResponse.ok && actionData.count > 0) {
                    document.getElementById('action-required-count').textContent = actionData.count;
                    document.getElementById('action-required-badge').style.display = 'inline-block';
                } else {
                    document.getElementById('action-required-badge').style.display = 'none';
                }

            } catch (error) {
                console.error('Error loading AI decisions:', error);
                document.getElementById('ai-decision-log-container').innerHTML =
                    '<div style="text-align: center; padding: 20px; color: #f44336;">Connection error</div>';
            }
        }

        function renderDecisions(decisions) {
            const container = document.getElementById('ai-decision-log-container');

            if (decisions.length === 0) {
                container.innerHTML = '<div style="text-align: center; padding: 20px; color: #888;">No decisions yet</div>';
                return;
            }

            const emoji = {
                'TRADE_OPEN': 'üîµ',
                'TRADE_CLOSE': 'üî¥',
                'SIGNAL_SKIP': '‚è≠Ô∏è',
                'SYMBOL_DISABLE': '‚õî',
                'SYMBOL_ENABLE': '‚úÖ',
                'RISK_LIMIT': '‚ö†Ô∏è',
                'CORRELATION_BLOCK': 'üîó',
                'NEWS_PAUSE': 'üì∞',
                'DD_LIMIT': 'üìâ',
                'SUPERTREND_SL': 'üéØ',
                'MTF_CONFLICT': 'üìä',
                'BACKTEST_START': 'üî¨',
                'BACKTEST_COMPLETE': '‚úÖ'
            };

            const impactColors = {
                'LOW': '#4CAF50',
                'MEDIUM': '#FFA500',
                'HIGH': '#FF5722',
                'CRITICAL': '#f44336'
            };

            let html = '<div style="display: flex; flex-direction: column; gap: 10px;">';

            decisions.forEach(d => {
                const time = new Date(d.timestamp).toLocaleString('de-DE');
                const decisionEmoji = emoji[d.decision_type] || 'ü§ñ';
                const impactColor = impactColors[d.impact_level] || '#888';

                // Decision outcome color
                let outcomeColor = '#888';
                if (d.decision === 'APPROVED') outcomeColor = '#4CAF50';
                if (d.decision === 'REJECTED') outcomeColor = '#f44336';
                if (d.decision === 'BLOCKED') outcomeColor = '#FF5722';
                if (d.decision === 'DISABLED') outcomeColor = '#f44336';
                if (d.decision === 'ENABLED') outcomeColor = '#4CAF50';

                html += `
                    <div style="background: ${d.user_action_required ? '#3a1f1f' : '#2a2a2a'}; border-left: 4px solid ${impactColor}; padding: 12px; border-radius: 6px; ${d.user_action_required ? 'box-shadow: 0 0 10px rgba(244,67,54,0.3);' : ''}">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                            <div style="display: flex; align-items: center; gap: 8px;">
                                <span style="font-size: 1.2em;">${decisionEmoji}</span>
                                <span style="font-weight: 600; color: #fff;">${d.decision_type.replace('_', ' ')}</span>
                                ${d.symbol ? `<span style="background: #444; padding: 2px 8px; border-radius: 4px; font-size: 0.85em;">${d.symbol}</span>` : ''}
                                ${d.timeframe ? `<span style="background: #444; padding: 2px 8px; border-radius: 4px; font-size: 0.85em;">${d.timeframe}</span>` : ''}
                            </div>
                            <div style="text-align: right;">
                                <div style="font-size: 0.85em; color: ${outcomeColor}; font-weight: 600;">${d.decision}</div>
                                <div style="font-size: 0.75em; color: #888;">${time}</div>
                            </div>
                        </div>

                        <div style="color: #fff; margin-bottom: 6px;">${d.primary_reason}</div>

                        ${d.user_action_required ? '<div style="background: #f44336; color: white; padding: 6px 10px; border-radius: 4px; font-size: 0.85em; font-weight: 600; display: inline-block; margin-top: 6px;">‚ö†Ô∏è ACTION REQUIRED</div>' : ''}

                        ${d.confidence_score ? `<div style="font-size: 0.85em; color: #888; margin-top: 6px;">Confidence: ${d.confidence_score.toFixed(1)}%</div>` : ''}

                        ${d.detailed_reasoning ? `<details style="margin-top: 8px; cursor: pointer;">
                            <summary style="font-size: 0.85em; color: #888; cursor: pointer;">View Details</summary>
                            <pre style="background: #1a1a1a; padding: 10px; border-radius: 4px; margin-top: 8px; font-size: 0.8em; color: #aaa; overflow-x: auto;">${d.detailed_reasoning}</pre>
                        </details>` : ''}
                    </div>
                `;
            });

            html += '</div>';
            container.innerHTML = html;
        }

        // Event listener for filter
        document.getElementById('decision-type-filter').addEventListener('change', loadAIDecisionLog);

        // Initial load and periodic refresh
        loadAIDecisionLog();
        setInterval(loadAIDecisionLog, 10000);  // Refresh every 10 seconds

        // Reduced polling interval to 30 seconds (WebSocket handles real-time price updates)
        setInterval(() => {
            updateSymbols();  // Refresh tick counts, timestamps, and trends
        }, 30000);

        // Countdown for next signal update (optimized for H1/H4 timeframes)
        // H1 candles close every 60 minutes (top of each hour: 10:00, 11:00, etc.)
        // H4 candles close every 4 hours (00:00, 04:00, 08:00, 12:00, 16:00, 20:00)
        // Check every 2 minutes for faster signal updates after candle close
        // (Variables already declared above near line 1930)

        // Countdown timer (1 second tick)
        setInterval(() => {
            signalCountdown--;
            if (signalCountdown <= 0) {
                updateSignals();  // Fetch signals when countdown reaches 0
                signalCountdown = signalInterval;  // Reset to 5 minutes
            }
            const countdownEl = document.getElementById('signal-countdown');
            if (countdownEl) {
                // Display minutes:seconds for better readability
                const mins = Math.floor(signalCountdown / 60);
                const secs = signalCountdown % 60;
                countdownEl.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
            }
        }, 1000);

        // Trigger immediate signal update (manual refresh)
        function triggerImmediateSignalUpdate() {
            console.log('üîÑ Manual signal discovery triggered');
            updateSignals();  // Fetch signals immediately
            signalCountdown = signalInterval;  // Reset countdown to full interval

            // Visual feedback - briefly change color
            const countdownEl = document.getElementById('signal-countdown');
            if (countdownEl) {
                const parent = countdownEl.parentElement;
                const originalColor = parent.style.color;
                parent.style.color = '#FF9800';
                setTimeout(() => {
                    parent.style.color = originalColor;
                }, 300);
            }
        }

        // ============================================================================
        // EXPLANATION MODAL FOR INDICATORS AND PATTERNS
        // ============================================================================

        function showExplanation(name, type) {
            const modal = document.getElementById('explanation-modal');
            const title = document.getElementById('explanation-title');
            const content = document.getElementById('explanation-content');

            const explanations = {
                indicator: {
                    'RSI': {
                        name: 'Relative Strength Index (RSI)',
                        description: 'Der RSI ist ein Momentum-Oszillator, der die Geschwindigkeit und Ver√§nderung von Preisbewegungen misst. Er wurde 1978 von J. Welles Wilder entwickelt und bewegt sich auf einer Skala von 0-100.',
                        interpretation: `
                            <strong>Berechnung:</strong><br>
                            RSI = 100 - (100 / (1 + RS))<br>
                            RS = Durchschnitt der Aufw√§rtsbewegungen / Durchschnitt der Abw√§rtsbewegungen (√ºblicherweise 14 Perioden)<br><br>

                            <strong>Interpretation der Zonen:</strong><br>
                            ‚Ä¢ <span style="color: #f44336;">RSI > 70:</span> √úberkaufter Bereich - Der Markt k√∂nnte √ºberhitzt sein, m√∂gliches Verkaufssignal<br>
                            ‚Ä¢ <span style="color: #4CAF50;">RSI < 30:</span> √úberverkaufter Bereich - Der Markt k√∂nnte √ºberverkauft sein, m√∂gliches Kaufsignal<br>
                            ‚Ä¢ RSI ‚âà 50: Neutrale Zone - Kein klares Signal<br><br>

                            <strong>Divergenzen (sehr wichtig!):</strong><br>
                            ‚Ä¢ <span style="color: #4CAF50;">Bullish Divergence:</span> Preis macht tiefere Tiefs, RSI macht h√∂here Tiefs ‚Üí Starkes Kaufsignal, Trendwende wahrscheinlich<br>
                            ‚Ä¢ <span style="color: #f44336;">Bearish Divergence:</span> Preis macht h√∂here Hochs, RSI macht tiefere Hochs ‚Üí Starkes Verkaufssignal, Trendwende wahrscheinlich<br><br>

                            <strong>Erweiterte Nutzung:</strong><br>
                            ‚Ä¢ Centerline Crossover: RSI kreuzt 50-Linie ‚Üí Best√§tigung von Trendrichtung<br>
                            ‚Ä¢ Failure Swings: RSI-Muster, das Umkehrungen signalisiert ohne Divergenzen<br>
                            ‚Ä¢ In starken Trends: RSI kann l√§ngere Zeit in √ºberkauften/√ºberverkauften Zonen bleiben<br><br>

                            <strong>Best Practices:</strong><br>
                            ‚Ä¢ Nutzen Sie RSI nicht isoliert - kombinieren Sie mit Trendanalyse<br>
                            ‚Ä¢ In starken Aufw√§rtstrends: RSI > 70 kann normal sein<br>
                            ‚Ä¢ In starken Abw√§rtstrends: RSI < 30 kann normal sein<br>
                            ‚Ä¢ Achten Sie besonders auf Divergenzen - sie sind oft sehr zuverl√§ssig
                        `
                    },
                    'MACD': {
                        name: 'Moving Average Convergence Divergence',
                        description: 'MACD ist ein Trend-Following Momentum-Indikator, der die Beziehung zwischen zwei exponentiellen gleitenden Durchschnitten (EMA) zeigt. Entwickelt von Gerald Appel in den sp√§ten 1970ern.',
                        interpretation: `
                            <strong>Komponenten:</strong><br>
                            ‚Ä¢ <span style="color: #4CAF50;">MACD-Linie:</span> EMA(12) - EMA(26)<br>
                            ‚Ä¢ <span style="color: #FFA726;">Signal-Linie:</span> EMA(9) der MACD-Linie<br>
                            ‚Ä¢ <span style="color: #2196F3;">Histogram:</span> MACD-Linie minus Signal-Linie<br><br>

                            <strong>Haupt-Signale:</strong><br>
                            ‚Ä¢ <span style="color: #4CAF50;">Bullish Crossover:</span> MACD kreuzt Signal-Linie von unten nach oben ‚Üí Kaufsignal<br>
                            ‚Ä¢ <span style="color: #f44336;">Bearish Crossover:</span> MACD kreuzt Signal-Linie von oben nach unten ‚Üí Verkaufssignal<br><br>

                            <strong>Centerline (Zero-Line) Crossovers:</strong><br>
                            ‚Ä¢ MACD kreuzt 0-Linie von unten: <span style="color: #4CAF50;">Bullish</span> - EMA(12) √ºberkreuzt EMA(26) nach oben<br>
                            ‚Ä¢ MACD kreuzt 0-Linie von oben: <span style="color: #f44336;">Bearish</span> - EMA(12) √ºberkreuzt EMA(26) nach unten<br>
                            ‚Ä¢ MACD √ºber 0: Genereller Aufw√§rtstrend<br>
                            ‚Ä¢ MACD unter 0: Genereller Abw√§rtstrend<br><br>

                            <strong>Histogram-Interpretation:</strong><br>
                            ‚Ä¢ Wachsendes Histogram: Momentum nimmt zu (Trend verst√§rkt sich)<br>
                            ‚Ä¢ Schrumpfendes Histogram: Momentum nimmt ab (Trend schw√§cht sich ab)<br>
                            ‚Ä¢ Histogram wechselt von positiv zu negativ: Fr√ºher Hinweis auf bearish Crossover<br>
                            ‚Ä¢ Histogram wechselt von negativ zu positiv: Fr√ºher Hinweis auf bullish Crossover<br><br>

                            <strong>Divergenzen:</strong><br>
                            ‚Ä¢ <span style="color: #4CAF50;">Bullish Divergence:</span> Preis macht niedrigere Tiefs, MACD macht h√∂here Tiefs ‚Üí Umkehr nach oben m√∂glich<br>
                            ‚Ä¢ <span style="color: #f44336;">Bearish Divergence:</span> Preis macht h√∂here Hochs, MACD macht niedrigere Hochs ‚Üí Umkehr nach unten m√∂glich<br><br>

                            <strong>Trading-Strategien:</strong><br>
                            ‚Ä¢ Trend-Following: Handeln Sie nur Crossovers in Trendrichtung<br>
                            ‚Ä¢ Histogram-Reversal: Histogram-Peaks k√∂nnen Umkehrpunkte signalisieren<br>
                            ‚Ä¢ Zero-Line Rejection: MACD n√§hert sich 0-Linie und dreht um ‚Üí Trend-Fortsetzung
                        `
                    },
                    'STOCH': {
                        name: 'Stochastic Oscillator',
                        description: 'Der Stochastic Oscillator vergleicht den aktuellen Schlusskurs mit der Preisspanne √ºber einen bestimmten Zeitraum (√ºblicherweise 14 Perioden). Entwickelt von George Lane in den sp√§ten 1950ern.',
                        interpretation: `
                            <strong>Berechnung:</strong><br>
                            %K = (Aktueller Schluss - Niedrigster Tief) / (H√∂chstes Hoch - Niedrigster Tief) √ó 100<br>
                            %D = 3-Perioden SMA von %K (Signal-Linie)<br><br>

                            <strong>√úberkauft/√úberverkauft Zonen:</strong><br>
                            ‚Ä¢ <span style="color: #f44336;">%K > 80:</span> √úberkaufter Bereich - M√∂gliche Verkaufsgelegenheit<br>
                            ‚Ä¢ <span style="color: #4CAF50;">%K < 20:</span> √úberverkaufter Bereich - M√∂gliche Kaufgelegenheit<br>
                            ‚Ä¢ Zwischen 20-80: Neutrale Zone<br><br>

                            <strong>Crossover-Signale:</strong><br>
                            ‚Ä¢ <span style="color: #4CAF50;">Bullish Signal:</span> %K kreuzt %D von unten in √ºberverkaufter Zone (< 20) ‚Üí Starkes Kaufsignal<br>
                            ‚Ä¢ <span style="color: #f44336;">Bearish Signal:</span> %K kreuzt %D von oben in √ºberkaufter Zone (> 80) ‚Üí Starkes Verkaufssignal<br>
                            ‚Ä¢ Crossovers in neutraler Zone sind weniger zuverl√§ssig<br><br>

                            <strong>Divergenzen:</strong><br>
                            ‚Ä¢ <span style="color: #4CAF50;">Bullish Divergence:</span> Preis macht tiefere Tiefs, Stochastic macht h√∂here Tiefs ‚Üí Kaufsignal<br>
                            ‚Ä¢ <span style="color: #f44336;">Bearish Divergence:</span> Preis macht h√∂here Hochs, Stochastic macht tiefere Hochs ‚Üí Verkaufssignal<br><br>

                            <strong>Bull/Bear Set-Ups:</strong><br>
                            ‚Ä¢ Bull Set-Up: Stochastic f√§llt unter 20, steigt wieder dar√ºber ‚Üí Best√§tigung eines Aufw√§rtstrends<br>
                            ‚Ä¢ Bear Set-Up: Stochastic steigt √ºber 80, f√§llt wieder darunter ‚Üí Best√§tigung eines Abw√§rtstrends<br><br>

                            <strong>Best Practices:</strong><br>
                            ‚Ä¢ In starken Trends kann Stochastic lange √ºberkauft/√ºberverkauft bleiben<br>
                            ‚Ä¢ Nutzen Sie Stochastic zusammen mit Trendanalyse<br>
                            ‚Ä¢ Fast Stochastic reagiert schneller, Slow Stochastic ist glatter (weniger Fehlsignale)<br>
                            ‚Ä¢ Warten Sie auf Crossover UND Verlassen der extremen Zone f√ºr st√§rkere Signale
                        `
                    },
                    'EMA_20': {
                        name: 'Exponential Moving Average (20)',
                        description: 'Gleitender Durchschnitt der letzten 20 Perioden mit h√∂herer Gewichtung aktueller Preise.',
                        interpretation: `
                            <strong>Verwendung:</strong><br>
                            ‚Ä¢ Preis √ºber EMA: <span style="color: #4CAF50;">Aufw√§rtstrend</span><br>
                            ‚Ä¢ Preis unter EMA: <span style="color: #f44336;">Abw√§rtstrend</span><br>
                            ‚Ä¢ Preis kreuzt EMA von unten: Kaufsignal<br>
                            ‚Ä¢ Preis kreuzt EMA von oben: Verkaufssignal<br><br>
                            <strong>Support/Resistance:</strong> EMA fungiert oft als dynamische Unterst√ºtzung/Widerstand
                        `
                    },
                    'EMA_50': {
                        name: 'Exponential Moving Average (50)',
                        description: 'Mittelfristiger Trend-Indikator √ºber 50 Perioden.',
                        interpretation: `
                            <strong>Verwendung:</strong><br>
                            ‚Ä¢ St√§rkerer Trend-Indikator als EMA-20<br>
                            ‚Ä¢ Golden Cross: EMA-20 kreuzt EMA-50 von unten ‚Üí <span style="color: #4CAF50;">Bullish</span><br>
                            ‚Ä¢ Death Cross: EMA-20 kreuzt EMA-50 von oben ‚Üí <span style="color: #f44336;">Bearish</span>
                        `
                    },
                    'BB': {
                        name: 'Bollinger Bands',
                        description: 'Volatilit√§tsindikator mit oberem und unterem Band um einen gleitenden Durchschnitt.',
                        interpretation: `
                            <strong>Interpretation:</strong><br>
                            ‚Ä¢ Preis ber√ºhrt oberes Band: √úberkauft, m√∂gliche Umkehr<br>
                            ‚Ä¢ Preis ber√ºhrt unteres Band: √úberverkauft, m√∂gliche Umkehr<br>
                            ‚Ä¢ Squeeze (enge B√§nder): Niedrige Volatilit√§t, Breakout steht bevor<br>
                            ‚Ä¢ Expansion (weite B√§nder): Hohe Volatilit√§t, starker Trend
                        `
                    },
                    'ATR': {
                        name: 'Average True Range',
                        description: 'Misst die Marktvolatilit√§t durch Durchschnitt der True Range √ºber N Perioden.',
                        interpretation: `
                            <strong>Verwendung:</strong><br>
                            ‚Ä¢ Hoher ATR: Hohe Volatilit√§t ‚Üí Gro√üe Preisbewegungen<br>
                            ‚Ä¢ Niedriger ATR: Niedrige Volatilit√§t ‚Üí Kleine Preisbewegungen<br><br>
                            <strong>Praktisch:</strong><br>
                            ‚Ä¢ Stop-Loss Platzierung (2-3x ATR)<br>
                            ‚Ä¢ Positionsgr√∂√üe basierend auf Volatilit√§t
                        `
                    }
                },
                pattern: {
                    'Hammer': {
                        name: 'Hammer',
                        description: 'Bullishes Umkehrmuster am Ende eines Abw√§rtstrends.',
                        interpretation: `
                            <strong>Erkennungsmerkmale:</strong><br>
                            ‚Ä¢ Kleiner K√∂rper am oberen Ende<br>
                            ‚Ä¢ Langer unterer Schatten (2-3x K√∂rpergr√∂√üe)<br>
                            ‚Ä¢ Kaum oberer Schatten<br><br>
                            <strong>Bedeutung:</strong><br>
                            ‚Ä¢ Verk√§ufer dr√ºckten Preis nach unten<br>
                            ‚Ä¢ K√§ufer √ºbernahmen und dr√ºckten zur√ºck<br>
                            ‚Ä¢ <span style="color: #4CAF50;">Bullishes Signal</span> bei Best√§tigung durch n√§chste Kerze
                        `,
                        svg: `<svg width="100" height="150" viewBox="0 0 100 150">
                            <rect x="40" y="20" width="20" height="15" fill="#4CAF50" stroke="#2E7D32" stroke-width="2"/>
                            <line x1="50" y1="35" x2="50" y2="130" stroke="#2E7D32" stroke-width="3"/>
                        </svg>`
                    },
                    'Shooting Star': {
                        name: 'Shooting Star (Sternschnuppe)',
                        description: 'Bearishes Umkehrmuster am Ende eines Aufw√§rtstrends.',
                        interpretation: `
                            <strong>Erkennungsmerkmale:</strong><br>
                            ‚Ä¢ Kleiner K√∂rper am unteren Ende<br>
                            ‚Ä¢ Langer oberer Schatten (2-3x K√∂rpergr√∂√üe)<br>
                            ‚Ä¢ Kaum unterer Schatten<br><br>
                            <strong>Bedeutung:</strong><br>
                            ‚Ä¢ K√§ufer dr√ºckten Preis nach oben<br>
                            ‚Ä¢ Verk√§ufer √ºbernahmen und dr√ºckten zur√ºck<br>
                            ‚Ä¢ <span style="color: #f44336;">Bearishes Signal</span> bei Best√§tigung
                        `,
                        svg: `<svg width="100" height="150" viewBox="0 0 100 150">
                            <line x1="50" y1="20" x2="50" y2="115" stroke="#C62828" stroke-width="3"/>
                            <rect x="40" y="115" width="20" height="15" fill="#f44336" stroke="#C62828" stroke-width="2"/>
                        </svg>`
                    },
                    'Doji': {
                        name: 'Doji',
                        description: 'Unentschlossenheitsmuster - Er√∂ffnung ‚âà Schluss.',
                        interpretation: `
                            <strong>Erkennungsmerkmale:</strong><br>
                            ‚Ä¢ Sehr kleiner oder kein K√∂rper<br>
                            ‚Ä¢ Schatten k√∂nnen variieren<br><br>
                            <strong>Bedeutung:</strong><br>
                            ‚Ä¢ Balance zwischen K√§ufern und Verk√§ufern<br>
                            ‚Ä¢ M√∂gliche Trendwende wenn nach starkem Trend<br>
                            ‚Ä¢ Braucht Best√§tigung durch Folgekerze
                        `,
                        svg: `<svg width="100" height="150" viewBox="0 0 100 150">
                            <line x1="50" y1="30" x2="50" y2="120" stroke="#666" stroke-width="3"/>
                            <rect x="48" y="73" width="4" height="4" fill="#666"/>
                        </svg>`
                    },
                    'Bullish Engulfing': {
                        name: 'Bullish Engulfing',
                        description: 'Starkes bullishes Umkehrmuster mit zwei Kerzen.',
                        interpretation: `
                            <strong>Erkennungsmerkmale:</strong><br>
                            ‚Ä¢ Erste Kerze: Klein, bearish (rot)<br>
                            ‚Ä¢ Zweite Kerze: Gro√ü, bullish (gr√ºn)<br>
                            ‚Ä¢ Zweite Kerze "verschlingt" die erste komplett<br><br>
                            <strong>Bedeutung:</strong><br>
                            ‚Ä¢ K√§ufer √ºbernahmen massiv die Kontrolle<br>
                            ‚Ä¢ Starkes <span style="color: #4CAF50;">Kaufsignal</span><br>
                            ‚Ä¢ Besonders stark nach Abw√§rtstrend
                        `,
                        svg: `<svg width="100" height="150" viewBox="0 0 100 150">
                            <rect x="30" y="60" width="15" height="25" fill="#f44336" stroke="#C62828" stroke-width="1"/>
                            <line x1="37.5" y1="50" x2="37.5" y2="90" stroke="#C62828" stroke-width="2"/>
                            <rect x="55" y="40" width="20" height="70" fill="#4CAF50" stroke="#2E7D32" stroke-width="2"/>
                            <line x1="65" y1="30" x2="65" y2="120" stroke="#2E7D32" stroke-width="2"/>
                        </svg>`
                    },
                    'Bearish Engulfing': {
                        name: 'Bearish Engulfing',
                        description: 'Starkes bearishes Umkehrmuster mit zwei Kerzen.',
                        interpretation: `
                            <strong>Erkennungsmerkmale:</strong><br>
                            ‚Ä¢ Erste Kerze: Klein, bullish (gr√ºn)<br>
                            ‚Ä¢ Zweite Kerze: Gro√ü, bearish (rot)<br>
                            ‚Ä¢ Zweite Kerze "verschlingt" die erste komplett<br><br>
                            <strong>Bedeutung:</strong><br>
                            ‚Ä¢ Verk√§ufer √ºbernahmen massiv die Kontrolle<br>
                            ‚Ä¢ Starkes <span style="color: #f44336;">Verkaufssignal</span><br>
                            ‚Ä¢ Besonders stark nach Aufw√§rtstrend
                        `,
                        svg: `<svg width="100" height="150" viewBox="0 0 100 150">
                            <rect x="30" y="60" width="15" height="25" fill="#4CAF50" stroke="#2E7D32" stroke-width="1"/>
                            <line x1="37.5" y1="50" x2="37.5" y2="90" stroke="#2E7D32" stroke-width="2"/>
                            <rect x="55" y="40" width="20" height="70" fill="#f44336" stroke="#C62828" stroke-width="2"/>
                            <line x1="65" y1="30" x2="65" y2="120" stroke="#C62828" stroke-width="2"/>
                        </svg>`
                    },
                    'Morning Star': {
                        name: 'Morning Star',
                        description: 'Bullishes Drei-Kerzen-Umkehrmuster.',
                        interpretation: `
                            <strong>Erkennungsmerkmale:</strong><br>
                            ‚Ä¢ Kerze 1: Lange bearish Kerze<br>
                            ‚Ä¢ Kerze 2: Kleine Kerze (Doji/Spinning Top) mit Gap nach unten<br>
                            ‚Ä¢ Kerze 3: Lange bullish Kerze<br><br>
                            <strong>Bedeutung:</strong><br>
                            ‚Ä¢ Trendwende von Abw√§rts zu Aufw√§rts<br>
                            ‚Ä¢ Sehr zuverl√§ssiges <span style="color: #4CAF50;">Kaufsignal</span>
                        `,
                        svg: `<svg width="120" height="150" viewBox="0 0 120 150">
                            <rect x="10" y="40" width="15" height="50" fill="#f44336" stroke="#C62828" stroke-width="2"/>
                            <rect x="48" y="100" width="8" height="8" fill="#666" stroke="#333" stroke-width="1"/>
                            <line x1="52" y1="95" x2="52" y2="113" stroke="#333" stroke-width="2"/>
                            <rect x="85" y="60" width="15" height="50" fill="#4CAF50" stroke="#2E7D32" stroke-width="2"/>
                        </svg>`
                    },
                    'Evening Star': {
                        name: 'Evening Star',
                        description: 'Bearishes Drei-Kerzen-Umkehrmuster.',
                        interpretation: `
                            <strong>Erkennungsmerkmale:</strong><br>
                            ‚Ä¢ Kerze 1: Lange bullish Kerze<br>
                            ‚Ä¢ Kerze 2: Kleine Kerze (Doji) mit Gap nach oben<br>
                            ‚Ä¢ Kerze 3: Lange bearish Kerze<br><br>
                            <strong>Bedeutung:</strong><br>
                            ‚Ä¢ Trendwende von Aufw√§rts zu Abw√§rts<br>
                            ‚Ä¢ Sehr zuverl√§ssiges <span style="color: #f44336;">Verkaufssignal</span>
                        `,
                        svg: `<svg width="120" height="150" viewBox="0 0 120 150">
                            <rect x="10" y="60" width="15" height="50" fill="#4CAF50" stroke="#2E7D32" stroke-width="2"/>
                            <rect x="48" y="45" width="8" height="8" fill="#666" stroke="#333" stroke-width="1"/>
                            <line x1="52" y1="40" x2="52" y2="58" stroke="#333" stroke-width="2"/>
                            <rect x="85" y="40" width="15" height="50" fill="#f44336" stroke="#C62828" stroke-width="2"/>
                        </svg>`
                    }
                }
            };

            const data = explanations[type][name];
            if (data) {
                title.textContent = data.name;
                content.innerHTML = `
                    <div style="line-height: 1.8;">
                        ${data.svg ? `<div style="text-align: center; margin: 20px 0; background: #2a2a2a; padding: 20px; border-radius: 8px;">${data.svg}</div>` : ''}
                        <p style="font-size: 1.1em; margin-bottom: 15px;">${data.description}</p>
                        <div style="background: #2a2a2a; padding: 15px; border-radius: 8px; border-left: 4px solid ${type === 'indicator' ? '#4CAF50' : '#FFA726'};">
                            ${data.interpretation}
                        </div>
                    </div>
                `;
                modal.style.display = 'flex';
            }
        }

        function closeExplanationModal() {
            document.getElementById('explanation-modal').style.display = 'none';
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('explanation-modal');
            if (event.target === modal) {
                closeExplanationModal();
            }
        }

        // ==================== NEW: TRADING STATISTICS ====================
        async function loadTradingStatistics() {
            try {
                const response = await fetch('/api/dashboard/statistics');
                const data = await response.json();

                if (data.status === 'success') {
                    renderStatisticsPeriod('stats-today', 'Today', data.statistics.today);
                    renderStatisticsPeriod('stats-week', 'This Week', data.statistics.week);
                    renderStatisticsPeriod('stats-month', 'This Month', data.statistics.month);
                    renderStatisticsPeriod('stats-all-time', 'All Time', data.statistics.all_time);
                }
            } catch (error) {
                console.error('Error loading trading statistics:', error);
            }
        }

        function renderStatisticsPeriod(elementId, title, stats) {
            const element = document.getElementById(elementId);
            const profitClass = stats.total_profit > stats.total_loss ? 'positive' : 'negative';
            const netProfit = stats.total_profit - stats.total_loss;

            element.innerHTML = `
                <div class="stat-period-title">${title}</div>
                <div class="stat-row">
                    <span class="label">Trades:</span>
                    <span class="value">${stats.total_trades} (${stats.winning_trades}W/${stats.losing_trades}L)</span>
                </div>
                <div class="stat-row">
                    <span class="label">Win Rate:</span>
                    <span class="value ${stats.win_rate >= 50 ? 'positive' : 'negative'}">${stats.win_rate}%</span>
                </div>
                <div class="stat-row">
                    <span class="label">Profit Factor:</span>
                    <span class="value ${stats.profit_factor >= 1 ? 'positive' : 'negative'}">${stats.profit_factor}</span>
                </div>
                <div class="stat-row">
                    <span class="label">Net Profit:</span>
                    <span class="value ${profitClass}">‚Ç¨${netProfit.toFixed(2)}</span>
                </div>
                <div class="stat-row">
                    <span class="label">Avg Win/Loss:</span>
                    <span class="value">‚Ç¨${stats.avg_win} / ‚Ç¨${stats.avg_loss}</span>
                </div>
                <div class="stat-row">
                    <span class="label">Best/Worst:</span>
                    <span class="value">‚Ç¨${stats.best_trade} / ‚Ç¨${stats.worst_trade}</span>
                </div>
                ${stats.avg_trade_duration_hours ? `
                <div class="stat-row">
                    <span class="label">Avg Duration:</span>
                    <span class="value">${stats.avg_trade_duration_hours}h</span>
                </div>
                ` : ''}
            `;
        }

        // ==================== NEW: OPEN POSITIONS ====================
        async function loadOpenTrades() {
            try {
                // Get current account ID from dashboard status
                const statusResponse = await fetch('/api/dashboard/status');
                const statusData = await statusResponse.json();
                const accountId = statusData?.account?.id || 1;  // Fallback to 1 if not found

                const response = await fetch('http://' + window.location.hostname + ':9900/api/monitoring/' + accountId);
                const data = await response.json();

                if (data && data.positions) {
                    const positions = data.positions;
                    
                    // Sort positions by profit (descending - highest profit first)
                    positions.sort((a, b) => b.pnl - a.pnl);
                    
                    document.getElementById('open-trades-count').textContent = positions.length;

                    if (positions.length === 0) {
                        document.getElementById('open-trades-list').innerHTML = '<div style="text-align: center; color: #888; padding: 20px;">No open positions</div>';
                    } else {
                        const gridHTML = '<div class="trades-grid">' + positions.map(pos => renderOpenTradeCard(pos)).join('') + '</div>';
                        document.getElementById('open-trades-list').innerHTML = gridHTML;
                    }
                } else {
                    document.getElementById('open-trades-list').innerHTML = '<div style="text-align: center; color: #888; padding: 20px;">No monitoring data available</div>';
                }
            } catch (error) {
                console.error('Error loading open trades:', error);
            }
        }

        function renderOpenTradeCard(pos, hasChanged = false) {
            const isProfitable = pos.pnl > 0;
            const profitClass = isProfitable ? 'profit' : (pos.pnl < 0 ? 'loss' : '');
            const directionClass = pos.direction === 'BUY' ? 'buy' : 'sell';
            const changedClass = hasChanged ? 'pnl-fade' : '';  // Changed to pnl-fade for P/L animation

            const openTime = new Date(pos.open_time);
            const now = new Date();
            const durationMs = now - openTime;
            const hours = Math.floor(durationMs / 3600000);
            const minutes = Math.floor((durationMs % 3600000) / 60000);

            return `
                <div class="trade-card ${profitClass}">
                    <div class="trade-card-header">
                        <span class="trade-symbol">${pos.symbol}</span>
                        <span class="trade-direction ${directionClass}">${pos.direction}</span>
                    </div>
                    <div class="trade-pnl ${profitClass} ${changedClass}">${isProfitable ? '+' : ''}‚Ç¨${pos.pnl.toFixed(2)}</div>
                    <div class="trade-info-row" style="background: rgba(100, 149, 237, 0.1); padding: 4px 6px; border-radius: 4px; margin: 4px 0;">
                        <span style="color: #6495ED; font-weight: bold;">Opened:</span>
                        <span class="value" style="font-size: 0.9em; color: #6495ED;">${pos.opening_reason || 'Manual (MT5)'}</span>
                    </div>
                    <div class="trade-info-row">
                        <span>Entry:</span>
                        <span class="value">${pos.open_price.toFixed(5)}</span>
                    </div>
                    <div class="trade-info-row">
                        <span>Current:</span>
                        <span class="value ${changedClass}">${pos.current_price.toFixed(5)}</span>
                    </div>
                    <div class="trade-info-row">
                        <span>Volume:</span>
                        <span class="value">${pos.volume}</span>
                    </div>
                    <div class="trade-info-row">
                        <span>TP:</span>
                        <span class="value">${pos.tp ? pos.tp.toFixed(5) + (pos.distance_to_tp_eur !== null && pos.distance_to_tp_eur !== undefined ? ' (Max Gain: ‚Ç¨' + (pos.distance_to_tp_eur >= 0 ? '+' : '') + pos.distance_to_tp_eur.toFixed(2) + ')' : '') : 'N/A'}</span>
                    </div>
                    <div class="trade-info-row">
                        <span>SL:</span>
                        <span class="value">${pos.sl ? pos.sl.toFixed(5) + (pos.distance_to_sl_eur !== null && pos.distance_to_sl_eur !== undefined ? ' (Max Loss: ‚Ç¨' + Math.abs(pos.distance_to_sl_eur).toFixed(2) + ')' : '') : 'N/A'}</span>
                    </div>
                    <div class="trade-info-row" style="background: ${pos.trailing_stop_info && pos.trailing_stop_info.enabled ? 'rgba(76, 175, 80, 0.1)' : 'rgba(128, 128, 128, 0.1)'}; padding: 8px; border-radius: 4px; margin: 6px 0; width: 100%; min-width: 100%;">
                        ${pos.trailing_stop_info && pos.trailing_stop_info.enabled ? `
                            <div style="display: flex; flex-direction: column; gap: 6px; width: 100%;">
                                <!-- Visual Progress Bar - FIXED WIDTH CONTAINER -->
                                <div style="width: 100%; height: 10px; background: rgba(128,128,128,0.2); border-radius: 5px; position: relative; overflow: visible; margin: 4px 0;">
                                    ${(() => {
                                        const profit = pos.trailing_stop_info.profit_percent;
                                        const isPositive = profit >= 0;
                                        const absWidth = Math.min(100, Math.abs(profit));

                                        if (profit < 0) {
                                            // Negative progress - show red bar going left from center (if we had negative space)
                                            // Since we can't go left, show red bar from start with different styling
                                            return `
                                                <!-- Red bar for negative progress -->
                                                <div style="height: 100%; background: linear-gradient(90deg, #f44336, #ef5350); border-radius: 5px; width: ${absWidth}%; opacity: 0.7; transition: width 0.3s ease;"></div>
                                                <!-- Zero line indicator -->
                                                <div style="position: absolute; top: -2px; left: 0; width: 2px; height: 14px; background: #fff; box-shadow: 0 0 3px rgba(0,0,0,0.3);" title="0% (Entry)"></div>
                                            `;
                                        } else {
                                            // Positive progress - green bar from start
                                            return `
                                                <!-- Green bar for positive progress -->
                                                <div style="height: 100%; background: linear-gradient(90deg, #4CAF50, #81C784); border-radius: 5px; width: ${absWidth}%; transition: width 0.3s ease;"></div>
                                            `;
                                        }
                                    })()}

                                    <!-- Stage markers -->
                                    <div style="position: absolute; top: 0; left: 0; width: 3px; height: 100%; background: rgba(255,255,255,0.6); border-radius: 1px;" title="0% - Entry"></div>
                                    <div style="position: absolute; top: 0; left: 10%; width: 2px; height: 100%; background: rgba(255,255,255,0.3);" title="10% - Break-Even"></div>
                                    <div style="position: absolute; top: 0; left: 30%; width: 2px; height: 100%; background: rgba(255,255,255,0.3);" title="30% - Partial"></div>
                                    <div style="position: absolute; top: 0; left: 60%; width: 2px; height: 100%; background: rgba(255,255,255,0.3);" title="60% - Aggressive"></div>
                                    <div style="position: absolute; top: 0; left: 85%; width: 2px; height: 100%; background: rgba(255,255,255,0.3);" title="85% - Near TP"></div>
                                    <div style="position: absolute; top: 0; left: 100%; width: 3px; height: 100%; background: rgba(255,215,0,0.5); margin-left: -3px;" title="100% - Take Profit"></div>

                                    <!-- Current position indicator -->
                                    ${pos.trailing_stop_info.profit_percent !== 0 ? `
                                        <div style="position: absolute; top: -3px; left: ${Math.max(0, Math.min(100, pos.trailing_stop_info.profit_percent))}%; width: 6px; height: 16px; background: ${pos.trailing_stop_info.profit_percent >= 0 ? '#4CAF50' : '#f44336'}; border-radius: 3px; margin-left: -3px; box-shadow: 0 0 4px rgba(0,0,0,0.4);" title="Current: ${pos.trailing_stop_info.profit_percent}%"></div>
                                    ` : ''}
                                </div>
                                <div style="display: flex; justify-content: space-between; padding-left: 20px; font-size: 0.9em; width: 100%;">
                                    <span style="color: #aaa;">Profit Progress:</span>
                                    <span class="value" style="color: ${pos.trailing_stop_info.profit_percent >= 0 ? '#4CAF50' : '#f44336'}; white-space: nowrap;">
                                        ${pos.trailing_stop_info.profit_percent >= 0 ? '' : '‚ö†Ô∏è '}${pos.trailing_stop_info.profit_percent}% of TP
                                    </span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding-left: 20px; font-size: 0.9em; width: 100%;">
                                    <span style="color: #aaa;" title="Profit/Loss if Stop Loss is hit">SL Protection:</span>
                                    <span class="value" style="color: ${pos.trailing_stop_info.protected_profit_eur >= 0 ? '#4CAF50' : '#f44336'}; font-weight: 600; white-space: nowrap;" title="Result if SL triggers">
                                        ${pos.trailing_stop_info.protected_profit_eur >= 0 ? '+' : ''}‚Ç¨${pos.trailing_stop_info.protected_profit_eur ? pos.trailing_stop_info.protected_profit_eur.toFixed(2) : '0.00'}
                                        ${pos.trailing_stop_info.protected_profit_eur > 0 ? '‚úì secured' : pos.trailing_stop_info.protected_profit_eur < 0 ? '‚ö†Ô∏è at risk' : 'break-even'}
                                    </span>
                                </div>
                                <div style="display: flex; justify-content: space-between; padding-left: 20px; font-size: 0.9em; width: 100%;">
                                    <span style="color: #aaa;" title="Distance from current price to Stop Loss">SL Buffer:</span>
                                    <span class="value" style="color: #81C784; font-size: 0.85em; white-space: nowrap;">
                                        ${pos.trailing_stop_info.sl_distance_pips ? pos.trailing_stop_info.sl_distance_pips.toFixed(1) : '0'} pips
                                    </span>
                                </div>
                                ${pos.trailing_stop_info.next_trigger ? `
                                    <div style="display: flex; justify-content: space-between; padding-left: 20px; font-size: 0.9em; border-top: 1px solid rgba(76, 175, 80, 0.2); padding-top: 4px; margin-top: 2px; width: 100%;">
                                        <span style="color: #aaa;">Next Stage:</span>
                                        <span class="value" style="color: #81C784; white-space: nowrap;">
                                            ${pos.trailing_stop_info.next_trigger} @ ${pos.trailing_stop_info.next_trigger_percent}%
                                        </span>
                                    </div>
                                ` : `
                                    <div style="text-align: center; font-size: 0.85em; color: #FFD700; font-weight: 600; border-top: 1px solid rgba(255, 215, 0, 0.2); padding-top: 4px; margin-top: 2px; width: 100%;">
                                        ‚≠ê Final Stage - Maximum Protection
                                    </div>
                                `}
                            </div>
                        ` : `
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="color: #888; font-weight: bold;">‚ö™ Trailing Stop</span>
                                <span class="value" style="color: #888;">Disabled</span>
                            </div>
                        `}
                    </div>
                    <div class="trade-info-row">
                        <span>Duration:</span>
                        <span class="value">${hours}h ${minutes}m</span>
                    </div>
                    <div class="trade-info-row">
                        <span>Ticket:</span>
                        <span class="value">#${pos.ticket}</span>
                    </div>
                    <div style="display: flex; gap: 8px; margin-top: 12px;">
                        <button data-action="close-trade" data-ticket="${pos.ticket}" data-pnl="${pos.pnl}" class="trade-action-btn trade-close-btn" title="Close this trade and lock in ${pos.pnl >= 0 ? '+' : ''}‚Ç¨${pos.pnl.toFixed(2)}">
                            ‚úï Close (‚Ç¨${pos.pnl.toFixed(2)})
                        </button>
                        <button data-action="set-trailing-stop" data-ticket="${pos.ticket}" data-symbol="${pos.symbol}" data-volume="${pos.volume}" class="trade-action-btn trade-ts-btn" title="Set trailing stop to protect ‚Ç¨${pos.pnl.toFixed(2)} profit">
                            üìà Set TS (‚Ç¨${pos.pnl.toFixed(2)})
                        </button>
                    </div>
                </div>
            `;
        }

        // ==================== NEW: TRADE HISTORY ====================
        // (currentPage already declared above near line 1789)

        async function loadTradedSymbols() {
            try {
                const response = await fetch('/api/dashboard/traded-symbols');
                const data = await response.json();

                if (data.status === 'success') {
                    const select = document.getElementById('history-symbol');
                    data.symbols.forEach(symbol => {
                        const option = document.createElement('option');
                        option.value = symbol;
                        option.textContent = symbol;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Error loading symbols:', error);
            }
        }

        async function loadTradeHistory(page = 1) {
            try {
                currentPage = page;
                const period = document.getElementById('history-period').value;
                const symbol = document.getElementById('history-symbol').value;
                const direction = document.getElementById('history-direction').value;
                const profitStatus = document.getElementById('history-profit-status').value;

                let url = `/api/trades/history?period=${period}&page=${page}&per_page=10`;
                if (symbol) url += `&symbol=${symbol}`;
                if (direction) url += `&direction=${direction}`;
                if (profitStatus) url += `&profit_status=${profitStatus}`;

                const response = await fetch(url);
                const data = await response.json();

                if (data.status === 'success') {
                    renderTradeHistory(data.trades);
                    renderPagination(data.pagination);
                }
            } catch (error) {
                console.error('Error loading trade history:', error);
            }
        }

        function renderTradeHistory(trades) {
            const listDiv = document.getElementById('trade-history-list');

            if (trades.length === 0) {
                listDiv.innerHTML = '<div style="text-align: center; color: #888; padding: 20px;">No trades found</div>';
                return;
            }

            let tableHTML = `
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Ticket</th>
                            <th>Symbol</th>
                            <th>Dir</th>
                            <th>TF</th>
                            <th>Conf%</th>
                            <th>Open</th>
                            <th>Close</th>
                            <th>Duration</th>
                            <th>Profit</th>
                            <th>Entry Reason</th>
                            <th>Exit Reason</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            trades.forEach(trade => {
                const profitColor = trade.profit > 0 ? '#4CAF50' : (trade.profit < 0 ? '#f44336' : '#888');
                const openTime = trade.open_time ? new Date(trade.open_time).toLocaleString('de-DE') : 'N/A';
                const closeTime = trade.close_time ? new Date(trade.close_time).toLocaleString('de-DE') : 'N/A';
                const duration = trade.duration_hours ? `${trade.duration_hours}h` : 'N/A';
                const timeframe = trade.timeframe || '-';
                const confidence = trade.confidence ? `${trade.confidence.toFixed(1)}%` : '-';
                const confidenceColor = trade.confidence >= 70 ? '#4CAF50' : (trade.confidence >= 55 ? '#FFA500' : '#888');

                tableHTML += `
                    <tr>
                        <td>#${trade.ticket}</td>
                        <td><strong>${trade.symbol}</strong></td>
                        <td><span class="trade-direction ${trade.direction.toLowerCase()}">${trade.direction}</span></td>
                        <td style="font-size: 0.85em; color: #888;">${timeframe}</td>
                        <td style="font-size: 0.85em; color: ${confidenceColor}; font-weight: 600;">${confidence}</td>
                        <td style="font-size: 0.8em;">${openTime}</td>
                        <td style="font-size: 0.8em;">${closeTime}</td>
                        <td>${duration}</td>
                        <td style="color: ${profitColor}; font-weight: 700;">${trade.profit > 0 ? '+' : ''}‚Ç¨${trade.profit ? trade.profit.toFixed(2) : '0.00'}</td>
                        <td style="font-size: 0.8em; color: #888;">${trade.entry_reason || '-'}</td>
                        <td style="font-size: 0.8em; color: ${trade.close_reason ? (trade.close_reason === 'TP_HIT' ? '#4CAF50' : trade.close_reason === 'SL_HIT' ? '#f44336' : '#FFA500') : '#888'};">${trade.close_reason || '-'}</td>
                    </tr>
                `;
            });

            tableHTML += '</tbody></table>';
            listDiv.innerHTML = tableHTML;
        }

        function renderPagination(pagination) {
            const paginationDiv = document.getElementById('trade-pagination');

            let html = '';

            // Previous button
            html += `<button class="pagination-btn" ${!pagination.has_prev ? 'disabled' : ''} onclick="loadTradeHistory(${pagination.page - 1})">‚Üê Prev</button>`;

            // Page info
            html += `<span style="color: #888; padding: 0 15px;">Page ${pagination.page} of ${pagination.total_pages} (${pagination.total} trades)</span>`;

            // Next button
            html += `<button class="pagination-btn" ${!pagination.has_next ? 'disabled' : ''} onclick="loadTradeHistory(${pagination.page + 1})">Next ‚Üí</button>`;

            paginationDiv.innerHTML = html;
        }

        // Load statistics and history on page load
        window.addEventListener('DOMContentLoaded', () => {
            loadTradingStatistics();
            loadOpenTrades();
            loadTradedSymbols();
            loadTradeHistory();

            // Event delegation for trade action buttons (prevents issues with dynamic re-rendering)
            document.getElementById('open-trades-list').addEventListener('click', (e) => {
                const btn = e.target.closest('button[data-action]');
                if (!btn) return;

                const action = btn.dataset.action;
                const ticket = parseInt(btn.dataset.ticket);

                if (action === 'close-trade') {
                    const pnl = parseFloat(btn.dataset.pnl);
                    // Disable button immediately to prevent double-clicks
                    btn.disabled = true;
                    btn.style.opacity = '0.5';
                    closeTrade(ticket, pnl);
                } else if (action === 'set-trailing-stop') {
                    const symbol = btn.dataset.symbol;
                    const volume = parseFloat(btn.dataset.volume);
                    showSetTrailingStopModal(ticket, symbol, volume);
                }
            });

            // Update open trades every 5 seconds
            setInterval(loadOpenTrades, 5000);

            // Update statistics every 30 seconds
            setInterval(loadTradingStatistics, 30000);
        });
    </script>

    <!-- Explanation Modal -->
    <div id="explanation-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; align-items: center; justify-content: center;">
        <div style="background: #2d2d2d; border-radius: 12px; max-width: 700px; width: 90%; max-height: 85vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.5);">
            <div style="padding: 25px; border-bottom: 2px solid #444;">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h2 id="explanation-title" style="margin: 0; color: #fff; font-size: 1.8em;">Indicator/Pattern</h2>
                    <button onclick="closeExplanationModal()" style="background: none; border: none; color: #fff; font-size: 2em; cursor: pointer; line-height: 1; padding: 0; width: 40px; height: 40px;">&times;</button>
                </div>
            </div>
            <div id="explanation-content" style="padding: 25px; color: #e0e0e0;">
                <!-- Content will be inserted here -->
            </div>
        </div>
    </div>

    <!-- Backtesting Section -->
    <div class="card" style="margin-top: 20px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin: 0;">üî¨ Backtesting</h2>
            <button onclick="showBacktestForm()" style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; font-size: 1em;">
                + Neuer Backtest
            </button>
        </div>

        <!-- Backtest Form (hidden by default) -->
        <div id="backtest-form" style="display: none; background: #2a2a2a; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
            <h3 style="margin: 0 0 15px 0; color: #4CAF50;">Backtest Konfiguration</h3>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div>
                    <label style="display: block; margin-bottom: 5px; color: #888; font-size: 0.9em;">Name:</label>
                    <input type="text" id="bt-name" placeholder="z.B. BTCUSD H1 Test" style="width: 100%; padding: 8px; background: #1a1a1a; border: 1px solid #444; color: #e0e0e0; border-radius: 4px;">
                </div>
                <div style="grid-column: 1 / -1;">
                    <label style="display: block; margin-bottom: 5px; color: #888; font-size: 0.9em;">Symbole (Komma-getrennt oder "ALL"):</label>
                    <input type="text" id="bt-symbol" value="ALL" placeholder="BTCUSD,EURUSD,XAUUSD oder ALL" style="width: 100%; padding: 8px; background: #1a1a1a; border: 1px solid #444; color: #e0e0e0; border-radius: 4px;">
                    <div style="font-size: 0.75em; color: #666; margin-top: 3px;">ALL = BTCUSD, EURUSD, GBPUSD, USDJPY, XAUUSD</div>
                </div>
                <div style="grid-column: 1 / -1;">
                    <label style="display: block; margin-bottom: 5px; color: #888; font-size: 0.9em;">Timeframes (Komma-getrennt oder "ALL"):</label>
                    <input type="text" id="bt-timeframe" value="H1,H4" placeholder="H1,H4 oder ALL" onchange="adjustBacktestDates()" style="width: 100%; padding: 8px; background: #1a1a1a; border: 1px solid #444; color: #e0e0e0; border-radius: 4px;">
                    <div style="font-size: 0.75em; color: #666; margin-top: 3px;">Standard: H1, H4 (optimal) | ALL = alle verf√ºgbaren Timeframes (langsamer)</div>
                </div>
                <div style="grid-column: 1 / -1;">
                    <label style="display: block; margin-bottom: 8px; color: #888; font-size: 0.9em;">‚è±Ô∏è Zeitraum-Vorlagen:</label>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 10px;">
                        <button onclick="setBacktestPeriod('1week')" type="button" style="background: #555; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85em;">
                            1 Woche
                        </button>
                        <button onclick="setBacktestPeriod('1month')" type="button" style="background: #555; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85em;">
                            1 Monat
                        </button>
                        <button onclick="setBacktestPeriod('3months')" type="button" style="background: #555; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85em;">
                            3 Monate
                        </button>
                        <button onclick="setBacktestPeriod('6months')" type="button" style="background: #555; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85em;">
                            6 Monate
                        </button>
                        <button onclick="setBacktestPeriod('1year')" type="button" style="background: #555; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 0.85em;">
                            1 Jahr
                        </button>
                    </div>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; color: #888; font-size: 0.9em;">Von (Datum):</label>
                    <input type="date" id="bt-start-date" style="width: 100%; padding: 8px; background: #1a1a1a; border: 1px solid #444; color: #e0e0e0; border-radius: 4px;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; color: #888; font-size: 0.9em;">Bis (Datum):</label>
                    <input type="date" id="bt-end-date" style="width: 100%; padding: 8px; background: #1a1a1a; border: 1px solid #444; color: #e0e0e0; border-radius: 4px;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; color: #888; font-size: 0.9em;">Initial Balance:</label>
                    <input type="number" id="bt-balance" value="1000" step="100" style="width: 100%; padding: 8px; background: #1a1a1a; border: 1px solid #444; color: #e0e0e0; border-radius: 4px;">
                </div>
                <div>
                    <label style="display: block; margin-bottom: 5px; color: #888; font-size: 0.9em;">Min. Confidence (%):</label>
                    <input type="number" id="bt-confidence" value="50" min="0" max="100" step="5" style="width: 100%; padding: 8px; background: #1a1a1a; border: 1px solid #444; color: #e0e0e0; border-radius: 4px;">
                    <div style="font-size: 0.75em; color: #666; margin-top: 3px;">Niedrigere Werte = Mehr Trades, H√∂here Werte = Weniger, aber sicherere Trades</div>
                </div>
            </div>
            <div style="display: flex; gap: 10px; margin-top: 15px;">
                <button onclick="runBacktest()" style="background: #4CAF50; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                    ‚ñ∂ Starten
                </button>
                <button onclick="hideBacktestForm()" style="background: #444; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer;">
                    Abbrechen
                </button>
            </div>
        </div>

        <!-- Backtest Results Table -->
        <div id="backtest-results" style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: #2a2a2a; text-align: left;">
                        <th style="padding: 12px; border-bottom: 2px solid #444;">ID</th>
                        <th style="padding: 12px; border-bottom: 2px solid #444;">Name</th>
                        <th style="padding: 12px; border-bottom: 2px solid #444;">Created</th>
                        <th style="padding: 12px; border-bottom: 2px solid #444;">Status</th>
                        <th style="padding: 12px; border-bottom: 2px solid #444;">Trades</th>
                        <th style="padding: 12px; border-bottom: 2px solid #444;">Win Rate</th>
                        <th style="padding: 12px; border-bottom: 2px solid #444;">Profit Factor</th>
                        <th style="padding: 12px; border-bottom: 2px solid #444;">Net Profit</th>
                        <th style="padding: 12px; border-bottom: 2px solid #444;" title="Worst-case estimate with spreads, slippage, and costs">Real. Profit</th>
                        <th style="padding: 12px; border-bottom: 2px solid #444;">Actions</th>
                    </tr>
                </thead>
                <tbody id="backtest-table-body">
                    <tr>
                        <td colspan="10" style="padding: 40px; text-align: center; color: #666;">
                            Keine Backtests vorhanden. Klicke auf "+ Neuer Backtest" um zu starten.
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Backtesting Functions

        function adjustBacktestDates() {
            const timeframesInput = document.getElementById('bt-timeframe').value.toUpperCase();
            const endDateInput = document.getElementById('bt-end-date');
            const startDateInput = document.getElementById('bt-start-date');

            // Determine required minimum days based on timeframes
            let minDays = 7; // Default for short timeframes (M5, M15, H1)

            if (timeframesInput.includes('D1') || timeframesInput === 'ALL') {
                minDays = 90; // D1 needs at least 30 days, recommend 90 for good results
            } else if (timeframesInput.includes('H4')) {
                minDays = 30; // H4 needs at least 9 days, recommend 30 for good results
            }

            // Set end date to today
            const today = new Date();
            const endDate = today.toISOString().split('T')[0];
            endDateInput.value = endDate;

            // Set start date based on required minimum
            const startDate = new Date(today);
            startDate.setDate(startDate.getDate() - minDays);
            startDateInput.value = startDate.toISOString().split('T')[0];
        }

        function showBacktestForm() {
            document.getElementById('backtest-form').style.display = 'block';
            // Auto-adjust dates when form is shown
            adjustBacktestDates();
        }

        function hideBacktestForm() {
            document.getElementById('backtest-form').style.display = 'none';
        }

        function setBacktestPeriod(period) {
            const today = new Date();
            const startDate = new Date();

            switch(period) {
                case '1week':
                    startDate.setDate(today.getDate() - 7);
                    break;
                case '1month':
                    startDate.setMonth(today.getMonth() - 1);
                    break;
                case '3months':
                    startDate.setMonth(today.getMonth() - 3);
                    break;
                case '6months':
                    startDate.setMonth(today.getMonth() - 6);
                    break;
                case '1year':
                    startDate.setFullYear(today.getFullYear() - 1);
                    break;
            }

            document.getElementById('bt-start-date').value = startDate.toISOString().split('T')[0];
            document.getElementById('bt-end-date').value = today.toISOString().split('T')[0];
        }

        async function requestMissingOHLCData(symbols, timeframes, startDate, endDate) {
            const apiBase = window.location.protocol + '//' + window.location.hostname + ':9900';
            const symbolList = symbols.split(',').map(s => s.trim());
            const timeframeList = timeframes.split(',').map(t => t.trim());

            let requestCount = 0;

            for (const symbol of symbolList) {
                for (const timeframe of timeframeList) {
                    try {
                        await fetch(apiBase + '/api/request_historical_data', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({
                                symbol: symbol,
                                timeframe: timeframe,
                                start_date: startDate,
                                end_date: endDate
                            })
                        });
                        requestCount++;
                        await new Promise(resolve => setTimeout(resolve, 50));
                    } catch (err) {
                        console.error(`Failed to request ${symbol} ${timeframe}:`, err);
                    }
                }
            }

            console.log(`üìä Requested ${requestCount} OHLC datasets from EA`);
            return requestCount;
        }

        async function runBacktest() {
            const name = document.getElementById('bt-name').value || 'Unnamed Backtest';
            let symbols = document.getElementById('bt-symbol').value.trim();
            const startDate = document.getElementById('bt-start-date').value;
            const endDate = document.getElementById('bt-end-date').value;
            let timeframes = document.getElementById('bt-timeframe').value.trim();
            const balance = parseFloat(document.getElementById('bt-balance').value);

            if (!startDate || !endDate) {
                alert('Bitte w√§hle Start- und Enddatum');
                return;
            }

            // Expand "ALL" to all symbols/timeframes
            if (symbols.toUpperCase() === 'ALL') {
                symbols = 'BTCUSD,EURUSD,GBPUSD,USDJPY,XAUUSD';
            }
            if (timeframes.toUpperCase() === 'ALL') {
                timeframes = 'H1,H4';  // Optimized: only H1 and H4 for best performance
            }

            // Get confidence value and convert from percentage to decimal (50% -> 0.50)
            const confidence = parseFloat(document.getElementById('bt-confidence').value) / 100;

            try {
                // First, request missing OHLC data from EA
                const requestedCount = await requestMissingOHLCData(symbols, timeframes, startDate, endDate);

                if (requestedCount > 0) {
                    alert(`üìä Fehlende OHLC-Daten werden angefordert (${requestedCount} Datasets).\n\nBacktest startet automatisch, sobald genug Daten vorhanden sind.\n\nDies kann 30-60 Sekunden dauern...`);
                }

                // Create backtest (API is on port 9900, WebUI is on 9905)
                const apiBase = window.location.protocol + '//' + window.location.hostname + ':9900';

                const createResponse = await fetch(apiBase + '/api/backtest/create', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        account_id: 1,
                        name: name,
                        symbols: symbols,
                        timeframes: timeframes,
                        start_date: startDate + 'T00:00:00Z',
                        end_date: endDate + 'T23:59:59Z',
                        initial_balance: balance,
                        min_confidence: confidence
                    })
                });

                const createData = await createResponse.json();

                // Check for validation errors
                if (!createResponse.ok || createData.error) {
                    alert('‚ùå Fehler beim Erstellen des Backtests:\n\n' + (createData.error || 'Unbekannter Fehler'));
                    return;
                }

                if (createData.backtest_id) {
                    // Start backtest immediately without alert
                    await fetch(apiBase + `/api/backtest/${createData.backtest_id}/start`, {method: 'POST'});

                    hideBacktestForm();
                    loadBacktestResults();
                }
            } catch (error) {
                alert('Fehler: ' + error.message);
            }
        }

        async function loadBacktestResults() {
            try {
                const apiBase = window.location.protocol + '//' + window.location.hostname + ':9900';
                const response = await fetch(apiBase + '/api/backtest/list?account_id=1');
                const data = await response.json();

                // Load realistic profit factor from settings
                const settingsResponse = await fetch(apiBase + '/api/settings');
                const settings = await settingsResponse.json();
                const realisticFactor = settings.realistic_profit_factor || 0.60;

                const tbody = document.getElementById('backtest-table-body');
                tbody.innerHTML = '';

                if (data.backtests && data.backtests.length > 0) {
                    data.backtests.forEach(bt => {
                        const row = document.createElement('tr');

                        // Format status badge with detailed progress
                        let statusBadge = '';
                        let statusText = bt.status;
                        if (bt.status === 'completed') statusBadge = '‚úÖ';
                        else if (bt.status === 'running') {
                            statusBadge = '‚è≥';
                            const progress = bt.progress_percent?.toFixed(1) || 0;
                            const currentDate = bt.current_processing_date ? new Date(bt.current_processing_date).toISOString().substring(0,10) : '';
                            const eta = bt.estimated_completion ? new Date(bt.estimated_completion).toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'}) : '';
                            statusText = `${progress}% ${currentDate ? '‚Ä¢ ' + currentDate : ''} ${eta ? '‚Ä¢ ETA ' + eta : ''}`;
                        }
                        else if (bt.status === 'failed') statusBadge = '‚ùå';
                        else statusBadge = '‚è∏Ô∏è';

                        // Calculate realistic profit using global settings
                        const realisticProfit = bt.net_profit ? bt.net_profit * realisticFactor : null;
                        const realisticColor = (realisticProfit || 0) >= 0 ? '#00cc00' : '#ff4444';

                        // Format created_at timestamp
                        const createdDate = bt.created_at ? new Date(bt.created_at) : null;
                        const createdStr = createdDate
                            ? `${createdDate.toLocaleDateString('de-DE', {day: '2-digit', month: '2-digit', year: 'numeric'})} ${createdDate.toLocaleTimeString('de-DE', {hour: '2-digit', minute: '2-digit'})}`
                            : '-';

                        row.innerHTML = `
                            <td style="color: #888; font-family: monospace;">#${bt.id}</td>
                            <td>${bt.name}</td>
                            <td style="color: #888; font-size: 0.9em; white-space: nowrap;">${createdStr}</td>
                            <td>${statusBadge} ${statusText}</td>
                            <td>${bt.total_trades || '-'}</td>
                            <td>${bt.win_rate ? (bt.win_rate * 100).toFixed(1) + '%' : '-'}</td>
                            <td>${bt.profit_factor ? (bt.profit_factor > 999 ? '‚àû' : bt.profit_factor.toFixed(2)) : '-'}</td>
                            <td style="color: ${(bt.net_profit || 0) >= 0 ? '#00ff00' : '#ff4444'}">
                                ${bt.net_profit ? (bt.net_profit >= 0 ? '+' : '') + bt.net_profit.toFixed(2) : '-'}
                            </td>
                            <td style="color: ${realisticColor}; font-style: italic;" title="Worst-case: Net Profit √ó 0.60 (assumes 40% loss from spreads, slippage, costs)">
                                ${realisticProfit !== null ? (realisticProfit >= 0 ? '+' : '') + realisticProfit.toFixed(2) : '-'}
                            </td>
                            <td>
                                ${bt.status === 'pending' ? `<button onclick="startBacktest(${bt.id})">‚ñ∂ Starten</button>` : ''}
                                ${bt.status === 'completed' || bt.status === 'failed' ? `<button onclick="retestBacktest(${bt.id})" style="background: #2196F3;" title="Retest with more recent data and current patterns/indicators">üîÑ Retest</button>` : ''}
                                <button onclick="viewBacktest(${bt.id})">üìä Details</button>
                                <button onclick="deleteBacktest(${bt.id})" style="background: #ff4444;">üóëÔ∏è L√∂schen</button>
                            </td>
                        `;
                        tbody.appendChild(row);
                    });
                } else {
                    tbody.innerHTML = '<tr><td colspan="10" style="text-align: center; opacity: 0.6;">Keine Backtests vorhanden. Klicke auf "+ Neuer Backtest" um zu starten.</td></tr>';
                }
            } catch (error) {
                console.error('Error loading backtests:', error);
            }
        }

        async function startBacktest(backtestId) {
            try {
                const apiBase = window.location.protocol + '//' + window.location.hostname + ':9900';
                await fetch(apiBase + `/api/backtest/${backtestId}/start`, {method: 'POST'});
                alert(`Backtest ${backtestId} gestartet!`);
                loadBacktestResults();
            } catch (error) {
                alert('Fehler: ' + error.message);
            }
        }

        async function viewBacktest(backtestId) {
            try {
                const apiBase = window.location.protocol + '//' + window.location.hostname + ':9900';
                const response = await fetch(apiBase + `/api/backtest/${backtestId}`);
                const bt = await response.json();

                const netProfit = bt.final_balance && bt.initial_balance ? bt.final_balance - bt.initial_balance : null;
                const netProfitStr = netProfit ? (netProfit >= 0 ? '+' : '') + netProfit.toFixed(2) : 'N/A';
                const netProfitColor = netProfit >= 0 ? '#00ff00' : '#ff4444';

                const detailsHTML = `
                    <div style="background: #1a1a1a; padding: 20px; border-radius: 8px; margin: 20px 0;">
                        <h3 style="margin-top: 0;">${bt.name} <span style="color: #666; font-size: 0.8em; font-family: monospace;">#${backtestId}</span></h3>

                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin: 20px 0;">
                            <div><strong>Status:</strong> ${bt.status}</div>
                            <div><strong>Symbole:</strong> ${bt.symbols}</div>
                            <div><strong>Zeitrahmen:</strong> ${bt.timeframes}</div>
                            <div><strong>Periode:</strong> ${bt.start_date?.substring(0,10)} - ${bt.end_date?.substring(0,10)}</div>
                        </div>

                        ${bt.status === 'running' ? `
                        <h4>‚è≥ Backtest Fortschritt</h4>
                        <div style="background: #2a2a2a; padding: 15px; border-radius: 6px; margin: 20px 0;">
                            <div style="margin-bottom: 10px;">
                                <strong>Fortschritt:</strong> ${bt.progress_percent?.toFixed(1) || 0}%
                                <div style="width: 100%; height: 20px; background: #1a1a1a; border-radius: 4px; margin-top: 5px; overflow: hidden;">
                                    <div style="width: ${bt.progress_percent || 0}%; height: 100%; background: linear-gradient(90deg, #4CAF50, #8BC34A); transition: width 0.3s;"></div>
                                </div>
                            </div>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 15px;">
                                <div><strong>Aktuelles Datum:</strong> ${bt.current_processing_date ? new Date(bt.current_processing_date).toLocaleString('de-DE') : 'N/A'}</div>
                                <div><strong>Voraussichtl. Ende:</strong> ${bt.estimated_completion ? new Date(bt.estimated_completion).toLocaleString('de-DE') : 'Wird berechnet...'}</div>
                                <div><strong>Verarbeitete Candles:</strong> ${bt.processed_candles?.toLocaleString('de-DE') || 0} / ${bt.total_candles?.toLocaleString('de-DE') || 0}</div>
                                <div><strong>Trades bisher:</strong> ${bt.total_trades || 0}</div>
                            </div>
                        </div>
                        ` : ''}

                        <h4>Performance</h4>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0;">
                            <div><strong>Initial Balance:</strong> $${bt.initial_balance?.toFixed(2) || 'N/A'}</div>
                            <div><strong>Final Balance:</strong> $${bt.final_balance?.toFixed(2) || 'N/A'}</div>
                            <div><strong>Net Profit:</strong> <span style="color: ${netProfitColor}">${netProfitStr}</span></div>
                        </div>

                        <h4>Trade Statistiken</h4>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin: 20px 0;">
                            <div><strong>Total Trades:</strong> ${bt.total_trades || 0}</div>
                            <div><strong>Winning:</strong> ${bt.winning_trades || 0}</div>
                            <div><strong>Losing:</strong> ${bt.losing_trades || 0}</div>
                            <div><strong>Win Rate:</strong> ${bt.win_rate ? (bt.win_rate * 100).toFixed(1) + '%' : 'N/A'}</div>
                        </div>

                        <h4>Risiko-Metriken</h4>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin: 20px 0;">
                            <div><strong>Profit Factor:</strong> ${bt.profit_factor ? (bt.profit_factor > 999 ? '‚àû' : bt.profit_factor.toFixed(2)) : 'N/A'}</div>
                            <div><strong>Max Drawdown:</strong> ${bt.max_drawdown?.toFixed(2) || 'N/A'}</div>
                            <div><strong>Sharpe Ratio:</strong> ${bt.sharpe_ratio?.toFixed(2) || 'N/A'}</div>
                        </div>

                        ${bt.error_message ? `<div style="background: #331111; padding: 10px; border-radius: 4px; margin-top: 15px;"><strong>Fehler:</strong> ${bt.error_message}</div>` : ''}

                        <h4>Trades</h4>
                        <div id="backtest-trades-list" style="margin: 20px 0;">
                            <p style="opacity: 0.6;">Lade Trades...</p>
                        </div>

                        <button onclick="closeBacktestDetails()" style="margin-top: 20px;">Schlie√üen</button>
                    </div>
                `;

                // Create modal
                const modal = document.createElement('div');
                modal.id = 'backtest-details-modal';
                modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 10000;';
                modal.innerHTML = `<div style="background: #0a0a0a; border: 1px solid #00ff00; border-radius: 8px; max-width: 1200px; max-height: 90vh; overflow-y: auto; padding: 20px;">${detailsHTML}</div>`;
                document.body.appendChild(modal);

                // Load trades
                loadBacktestTrades(backtestId);
            } catch (error) {
                alert('Fehler beim Laden der Details: ' + error.message);
            }
        }

        function closeBacktestDetails() {
            const modal = document.getElementById('backtest-details-modal');
            if (modal) modal.remove();
        }

        async function loadBacktestTrades(backtestId) {
            try {
                const apiBase = window.location.protocol + '//' + window.location.hostname + ':9900';
                const response = await fetch(apiBase + `/api/backtest/${backtestId}/trades`);
                const data = await response.json();

                const container = document.getElementById('backtest-trades-list');
                if (!container) return;

                if (data.trades && data.trades.length > 0) {
                    container.innerHTML = `
                        <table style="width: 100%; font-size: 12px; border-collapse: collapse;">
                            <thead>
                                <tr style="background: #1a1a1a; border-bottom: 1px solid #00ff00;">
                                    <th style="padding: 8px; text-align: left;">Symbol</th>
                                    <th style="padding: 8px; text-align: left;">TF</th>
                                    <th style="padding: 8px; text-align: left;">Zeit</th>
                                    <th style="padding: 8px; text-align: left;">Richtung</th>
                                    <th style="padding: 8px; text-align: left;">Entry Grund</th>
                                    <th style="padding: 8px; text-align: left;">Exit Grund</th>
                                    <th style="padding: 8px; text-align: right;">Profit</th>
                                    <th style="padding: 8px; text-align: center;">TS</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.trades.map(t => `
                                    <tr style="border-bottom: 1px solid #333;">
                                        <td style="padding: 8px; font-weight: bold; color: #4CAF50;">${t.symbol || '-'}</td>
                                        <td style="padding: 8px; color: #888; font-size: 11px;">${t.timeframe || '-'}</td>
                                        <td style="padding: 8px;">${t.entry_time ? t.entry_time.substring(0, 16).replace('T', ' ') : '-'}</td>
                                        <td style="padding: 8px;">
                                            <span style="color: ${t.direction === 'BUY' ? '#00ff00' : '#ff4444'}; font-weight: bold;">
                                                ${t.direction}
                                            </span>
                                        </td>
                                        <td style="padding: 8px; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${t.entry_reason || '-'}">
                                            ${t.entry_reason || '-'}
                                        </td>
                                        <td style="padding: 8px;">${t.exit_reason || '-'}</td>
                                        <td style="padding: 8px; text-align: right; color: ${t.profit >= 0 ? '#00ff00' : '#ff4444'}; font-weight: bold;">
                                            ${t.profit != null ? (t.profit >= 0 ? '+' : '') + t.profit.toFixed(2) : '-'}
                                        </td>
                                        <td style="padding: 8px; text-align: center; font-size: 14px;">
                                            ${t.trailing_stop_used ? '‚úì' : '-'}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    `;
                } else {
                    container.innerHTML = '<p style="opacity: 0.6; text-align: center; padding: 20px;">Keine Trades vorhanden</p>';
                }
            } catch (error) {
                console.error('Error loading backtest trades:', error);
                const container = document.getElementById('backtest-trades-list');
                if (container) {
                    container.innerHTML = '<p style="color: #ff4444; text-align: center; padding: 20px;">Fehler beim Laden der Trades</p>';
                }
            }
        }

        async function retestBacktest(backtestId) {
            try {
                const apiBase = window.location.protocol + '//' + window.location.hostname + ':9900';

                // Get original backtest details
                const response = await fetch(apiBase + `/api/backtest/${backtestId}`);
                const bt = await response.json();

                // Confirm retest
                const confirmed = confirm(
                    `üîÑ Retest Backtest #${backtestId}: "${bt.name}"\n\n` +
                    `This will create a new backtest with:\n` +
                    `‚Ä¢ Same symbols: ${bt.symbols}\n` +
                    `‚Ä¢ Same timeframes: ${bt.timeframes}\n` +
                    `‚Ä¢ Updated end date: TODAY\n` +
                    `‚Ä¢ Same duration: ${bt.start_date?.substring(0,10)} to ${new Date().toISOString().substring(0,10)}\n` +
                    `‚Ä¢ Same balance: $${bt.initial_balance}\n` +
                    `‚Ä¢ Current patterns & indicators (including new Harami patterns)\n\n` +
                    `Continue?`
                );

                if (!confirmed) return;

                // Calculate new date range (same duration, but ending today)
                const originalStart = new Date(bt.start_date);
                const originalEnd = new Date(bt.end_date);
                const durationDays = Math.ceil((originalEnd - originalStart) / (1000 * 60 * 60 * 24));

                const newEndDate = new Date();
                const newStartDate = new Date(newEndDate);
                newStartDate.setDate(newStartDate.getDate() - durationDays);

                // Create new backtest with same parameters but updated dates
                const createResponse = await fetch(apiBase + '/api/backtest/create', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        account_id: 1,  // Always use account 1
                        name: `${bt.name} (Retest ${new Date().toISOString().substring(0,10)})`,
                        symbols: bt.symbols,
                        timeframes: bt.timeframes,
                        start_date: newStartDate.toISOString().split('T')[0] + 'T00:00:00Z',
                        end_date: newEndDate.toISOString().split('T')[0] + 'T23:59:59Z',
                        initial_balance: bt.initial_balance,
                        min_confidence: bt.min_confidence || 0.60
                    })
                });

                const createData = await createResponse.json();

                if (!createResponse.ok || createData.error) {
                    alert('‚ùå Fehler beim Erstellen des Retest:\n\n' + (createData.error || 'Unbekannter Fehler'));
                    return;
                }

                if (createData.backtest_id) {
                    // Start backtest immediately
                    await fetch(apiBase + `/api/backtest/${createData.backtest_id}/start`, {method: 'POST'});

                    alert(`‚úÖ Retest #${createData.backtest_id} gestartet!\n\nPeriode: ${newStartDate.toISOString().substring(0,10)} bis ${newEndDate.toISOString().substring(0,10)}`);
                    loadBacktestResults();
                }
            } catch (error) {
                alert('Fehler beim Retest: ' + error.message);
            }
        }

        async function deleteBacktest(backtestId) {
            try {
                const apiBase = window.location.protocol + '//' + window.location.hostname + ':9900';
                const response = await fetch(apiBase + `/api/backtest/${backtestId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    loadBacktestResults();
                } else {
                    const data = await response.json();
                    alert('Fehler: ' + (data.error || 'Unbekannter Fehler'));
                }
            } catch (error) {
                alert('Fehler: ' + error.message);
            }
        }

        // Load backtests on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadBacktestResults();

            // Auto-refresh every 3 seconds to update progress
            setInterval(() => {
                loadBacktestResults();
            }, 3000);
        });
    </script>

    <!-- Settings Modal -->
    <div id="settings-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; overflow-y: auto;">
        <div style="max-width: 800px; margin: 50px auto; background: #1a1a1a; border-radius: 10px; padding: 30px;">
            <h2 style="margin: 0 0 20px 0; color: #4CAF50;">‚öôÔ∏è Global Settings</h2>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                <!-- Risk Management -->
                <div style="grid-column: 1 / -1; background: #2a2a2a; padding: 15px; border-radius: 8px;">
                    <h3 style="margin: 0 0 15px 0; color: #FFA726;">üìä Risk Management</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #888;">Max Positions:</label>
                            <input type="number" id="set-max-positions" min="1" max="20" style="width: 100%; padding: 8px; background: #1a1a1a; border: 1px solid #444; color: #e0e0e0; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #888;">Risk per Trade (%):</label>
                            <input type="number" id="set-risk-per-trade" min="0.1" max="10" step="0.1" style="width: 100%; padding: 8px; background: #1a1a1a; border: 1px solid #444; color: #e0e0e0; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #888;">Position Size (%):</label>
                            <input type="number" id="set-position-size" min="0.1" max="10" step="0.1" style="width: 100%; padding: 8px; background: #1a1a1a; border: 1px solid #444; color: #e0e0e0; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #888;">Max Drawdown (%):</label>
                            <input type="number" id="set-max-drawdown" min="1" max="50" step="1" style="width: 100%; padding: 8px; background: #1a1a1a; border: 1px solid #444; color: #e0e0e0; border-radius: 4px;">
                        </div>
                    </div>
                </div>

                <!-- Signal Processing -->
                <div style="grid-column: 1 / -1; background: #2a2a2a; padding: 15px; border-radius: 8px;">
                    <h3 style="margin: 0 0 15px 0; color: #2196F3;">üéØ Signal Processing</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #888;">Min Confidence (%):</label>
                            <input type="number" id="set-min-confidence" min="0" max="100" step="5" style="width: 100%; padding: 8px; background: #1a1a1a; border: 1px solid #444; color: #e0e0e0; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #888;">Max Signal Age (minutes):</label>
                            <input type="number" id="set-signal-age" min="1" max="60" style="width: 100%; padding: 8px; background: #1a1a1a; border: 1px solid #444; color: #e0e0e0; border-radius: 4px;">
                        </div>
                    </div>
                </div>

                <!-- Cooldown -->
                <div style="grid-column: 1 / -1; background: #2a2a2a; padding: 15px; border-radius: 8px;">
                    <h3 style="margin: 0 0 15px 0; color: #9C27B0;">üïê Cooldown Settings</h3>
                    <div>
                        <label style="display: block; margin-bottom: 5px; color: #888;">SL Cooldown (minutes):</label>
                        <input type="number" id="set-sl-cooldown" min="0" max="240" step="15" style="width: 100%; padding: 8px; background: #1a1a1a; border: 1px solid #444; color: #e0e0e0; border-radius: 4px;">
                        <div style="font-size: 0.85em; color: #666; margin-top: 5px;">Prevents re-entry after SL hit (0 = disabled)</div>
                    </div>
                </div>

                <!-- Backtest Settings -->
                <div style="grid-column: 1 / -1; background: #2a2a2a; padding: 15px; border-radius: 8px;">
                    <h3 style="margin: 0 0 15px 0; color: #00BCD4;">üî¨ Backtest Settings</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #888;">Min Bars Required:</label>
                            <input type="number" id="set-min-bars" min="10" max="200" style="width: 100%; padding: 8px; background: #1a1a1a; border: 1px solid #444; color: #e0e0e0; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #888;">Min Bars D1:</label>
                            <input type="number" id="set-min-bars-d1" min="10" max="100" style="width: 100%; padding: 8px; background: #1a1a1a; border: 1px solid #444; color: #e0e0e0; border-radius: 4px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #888;">Realistic Profit Factor:</label>
                            <input type="number" id="set-realistic-factor" min="0.1" max="1.0" step="0.05" style="width: 100%; padding: 8px; background: #1a1a1a; border: 1px solid #444; color: #e0e0e0; border-radius: 4px;">
                            <div style="font-size: 0.85em; color: #666; margin-top: 5px;">0.60 = 40% costs</div>
                        </div>
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 25px; justify-content: flex-end;">
                <button onclick="saveSettings()" style="background: #4CAF50; color: white; border: none; padding: 12px 30px; border-radius: 5px; cursor: pointer; font-size: 1em;">
                    üíæ Save Settings
                </button>
                <button onclick="closeSettingsModal()" style="background: #666; color: white; border: none; padding: 12px 30px; border-radius: 5px; cursor: pointer; font-size: 1em;">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <script>
        async function showSettingsModal() {
            try {
                const apiBase = window.location.protocol + '//' + window.location.hostname + ':9900';
                const response = await fetch(apiBase + '/api/settings');
                const settings = await response.json();

                // Populate form
                document.getElementById('set-max-positions').value = settings.max_positions;
                document.getElementById('set-risk-per-trade').value = (settings.risk_per_trade_percent * 100).toFixed(1);
                document.getElementById('set-position-size').value = (settings.position_size_percent * 100).toFixed(1);
                document.getElementById('set-max-drawdown').value = (settings.max_drawdown_percent * 100).toFixed(0);
                document.getElementById('set-min-confidence').value = (settings.min_signal_confidence * 100).toFixed(0);
                document.getElementById('set-signal-age').value = settings.signal_max_age_minutes;
                document.getElementById('set-sl-cooldown').value = settings.sl_cooldown_minutes;
                document.getElementById('set-min-bars').value = settings.min_bars_required;
                document.getElementById('set-min-bars-d1').value = settings.min_bars_d1;
                document.getElementById('set-realistic-factor').value = settings.realistic_profit_factor.toFixed(2);

                document.getElementById('settings-modal').style.display = 'flex';
            } catch (error) {
                alert('Error loading settings: ' + error.message);
            }
        }

        function closeSettingsModal() {
            document.getElementById('settings-modal').style.display = 'none';
        }

        async function saveSettings() {
            try {
                const settings = {
                    max_positions: parseInt(document.getElementById('set-max-positions').value),
                    risk_per_trade_percent: parseFloat(document.getElementById('set-risk-per-trade').value) / 100,
                    position_size_percent: parseFloat(document.getElementById('set-position-size').value) / 100,
                    max_drawdown_percent: parseFloat(document.getElementById('set-max-drawdown').value) / 100,
                    min_signal_confidence: parseFloat(document.getElementById('set-min-confidence').value) / 100,
                    signal_max_age_minutes: parseInt(document.getElementById('set-signal-age').value),
                    sl_cooldown_minutes: parseInt(document.getElementById('set-sl-cooldown').value),
                    min_bars_required: parseInt(document.getElementById('set-min-bars').value),
                    min_bars_d1: parseInt(document.getElementById('set-min-bars-d1').value),
                    realistic_profit_factor: parseFloat(document.getElementById('set-realistic-factor').value)
                };

                const apiBase = window.location.protocol + '//' + window.location.hostname + ':9900';
                const response = await fetch(apiBase + '/api/settings', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(settings)
                });

                if (response.ok) {
                    alert('‚úÖ Settings saved successfully!');
                    closeSettingsModal();
                } else {
                    const data = await response.json();
                    alert('Error: ' + (data.error || 'Unknown error'));
                }
            } catch (error) {
                alert('Error saving settings: ' + error.message);
            }
        }

        // ==================== TRADE MANAGEMENT FUNCTIONS ====================

        // Close individual trade
        async function closeTrade(ticket, pnl) {
            // Only ask for confirmation if closing at a loss
            if (pnl < 0) {
                if (!confirm(`Close trade #${ticket} at a loss of ‚Ç¨${Math.abs(pnl).toFixed(2)}?`)) {
                    return;
                }
            }

            try {
                const response = await fetch(`/api/close_trade/${ticket}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });

                if (!response.ok) {
                    console.error(`Failed to close trade ${ticket}: HTTP ${response.status}`);
                    return;
                }

                const data = await response.json();

                if (data.status === 'success') {
                    // Silent close - just refresh after short delay
                    setTimeout(() => {
                        loadOpenTrades();
                    }, 500);
                } else {
                    console.error(`Failed to close trade ${ticket}: ${data.message}`);
                }
            } catch (error) {
                console.error('Close trade error:', error);
            }
        }

        // Close all profitable trades (NO CONFIRMATION - immediate execution!)
        async function closeAllProfitable() {
            try {
                const response = await fetch('/api/close_all_profitable', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                const data = await response.json();

                if (data.status === 'success') {
                    // Show brief success notification (no alert blocking)
                    console.log(`‚úì ${data.message} - Tickets: ${data.tickets.join(', ')}`);
                    loadOpenTrades(); // Refresh immediately
                } else if (data.status === 'info') {
                    console.log(`‚Ñπ ${data.message}`);
                } else {
                    console.error(`‚úó Error: ${data.message}`);
                }
            } catch (error) {
                console.error(`‚úó Error: ${error.message}`);
            }
        }

        // Confirm close all trades
        function confirmCloseAll() {
            document.getElementById('close-all-modal').style.display = 'flex';
        }

        // Close all trades
        async function closeAllTrades() {
            document.getElementById('close-all-modal').style.display = 'none';

            try {
                const response = await fetch('/api/close_all_trades', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                const data = await response.json();

                if (data.status === 'success') {
                    alert(`‚úì ${data.message}\n\nTickets: ${data.tickets.join(', ')}`);
                    loadOpenTrades(); // Refresh
                } else if (data.status === 'info') {
                    alert(`‚Ñπ ${data.message}`);
                } else {
                    alert(`‚úó Error: ${data.message}`);
                }
            } catch (error) {
                alert(`‚úó Error: ${error.message}`);
            }
        }

        // Calculate ‚Ç¨ value for trailing stop distance
        function calculateTSValue(symbol, volume, pips) {
            // Pip values per standard lot (simplified)
            let pipValuePerLot = 10; // Default for most Forex pairs (EUR/USD, GBP/USD, etc.)

            // Symbol-specific adjustments
            if (symbol.includes('JPY')) {
                pipValuePerLot = 9.09; // JPY pairs (e.g., USD/JPY: 1000 / 110 ‚âà 9.09)
            } else if (symbol.includes('XAU') || symbol.includes('GOLD')) {
                pipValuePerLot = 10; // Gold: $10 per pip per lot
            } else if (symbol.includes('BTC')) {
                pipValuePerLot = 10; // BTC: ~$10 per pip (simplified)
            } else if (symbol.includes('EUR') || symbol.includes('GBP')) {
                pipValuePerLot = 10; // Major Forex pairs
            }

            // Calculate total value: pips √ó pip_value_per_lot √ó volume
            const value = pips * pipValuePerLot * volume;
            return value;
        }

        // Show trailing stop modal
        function showSetTrailingStopModal(ticket, symbol, volume) {
            // Calculate realistic default pips based on position size
            let basePips = 20; // Safe fallback

            // Dynamic pip calculation based on volume (lot size)
            if (volume <= 0.01) {
                basePips = 10; // Micro lots: tight stop
            } else if (volume <= 0.05) {
                basePips = 15; // Small positions
            } else if (volume <= 0.1) {
                basePips = 25; // Medium positions
            } else if (volume <= 0.5) {
                basePips = 35; // Larger positions
            } else {
                basePips = 50; // Very large positions
            }

            // Calculate preset options: Conservative, Recommended, Aggressive
            const conservative = Math.round(basePips * 1.5);
            const recommended = basePips;
            const aggressive = Math.round(basePips * 0.6);

            // Calculate ‚Ç¨ values
            const conservativeValue = calculateTSValue(symbol, volume, conservative);
            const recommendedValue = calculateTSValue(symbol, volume, recommended);
            const aggressiveValue = calculateTSValue(symbol, volume, aggressive);

            console.log(`üí° TS Options for ${symbol} (${volume} lots): Conservative=${conservative} pips (‚Ç¨${conservativeValue.toFixed(2)}), Recommended=${recommended} pips (‚Ç¨${recommendedValue.toFixed(2)}), Aggressive=${aggressive} pips (‚Ç¨${aggressiveValue.toFixed(2)})`);

            document.getElementById('ts-ticket').textContent = ticket;
            document.getElementById('ts-symbol').textContent = symbol;
            document.getElementById('ts-volume').textContent = volume;
            document.getElementById('ts-input').value = recommended;
            document.getElementById('ts-input').placeholder = `e.g. ${recommended}`;

            // Update quick-select buttons with ‚Ç¨ values
            document.getElementById('ts-conservative').innerHTML = `${conservative} pips<br><small style="opacity: 0.7;">‚âà ‚Ç¨${conservativeValue.toFixed(2)}</small>`;
            document.getElementById('ts-conservative').onclick = () => selectTSPreset(conservative, symbol, volume);
            document.getElementById('ts-recommended').innerHTML = `${recommended} pips<br><small style="opacity: 0.7;">‚âà ‚Ç¨${recommendedValue.toFixed(2)}</small>`;
            document.getElementById('ts-recommended').onclick = () => selectTSPreset(recommended, symbol, volume);
            document.getElementById('ts-aggressive').innerHTML = `${aggressive} pips<br><small style="opacity: 0.7;">‚âà ‚Ç¨${aggressiveValue.toFixed(2)}</small>`;
            document.getElementById('ts-aggressive').onclick = () => selectTSPreset(aggressive, symbol, volume);

            // Store symbol and volume for live calculation
            document.getElementById('ts-modal').dataset.symbol = symbol;
            document.getElementById('ts-modal').dataset.volume = volume;

            // Update ‚Ç¨ value display on input change
            updateTSValueDisplay();
            document.getElementById('ts-input').oninput = updateTSValueDisplay;

            document.getElementById('ts-modal').style.display = 'flex';
        }

        function selectTSPreset(pips, symbol, volume) {
            document.getElementById('ts-input').value = pips;
            updateTSValueDisplay();
            // Visual feedback
            document.getElementById('ts-input').style.background = '#2a4a2a';
            setTimeout(() => {
                document.getElementById('ts-input').style.background = '';
            }, 200);
        }

        function updateTSValueDisplay() {
            const pips = parseFloat(document.getElementById('ts-input').value) || 0;
            const symbol = document.getElementById('ts-modal').dataset.symbol;
            const volume = parseFloat(document.getElementById('ts-modal').dataset.volume);

            if (pips > 0 && symbol && volume) {
                const value = calculateTSValue(symbol, volume, pips);
                document.getElementById('ts-value-display').innerHTML =
                    `<strong style="color: #4CAF50;">‚âà ‚Ç¨${value.toFixed(2)}</strong> maximum risk if stopped out`;
            } else {
                document.getElementById('ts-value-display').innerHTML = '';
            }
        }

        // Set trailing stop
        async function setTrailingStop() {
            const ticket = document.getElementById('ts-ticket').textContent;
            const pips = document.getElementById('ts-input').value;

            if (!pips || pips <= 0) {
                alert('Please enter a valid trailing stop value in pips');
                return;
            }

            document.getElementById('ts-modal').style.display = 'none';

            try {
                const apiBase = window.location.protocol + '//' + window.location.hostname + ':9905';
                const response = await fetch(`${apiBase}/api/set_trailing_stop/${ticket}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({trailing_stop_pips: parseFloat(pips)})
                });
                const data = await response.json();

                if (data.status === 'success') {
                    alert(`‚úì ${data.message}`);
                } else {
                    alert(`‚úó Error: ${data.message}`);
                }
            } catch (error) {
                alert(`‚úó Error: ${error.message}`);
            }
        }

        // Close modals
        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // ‚úÖ NEW: Safety Monitor Functions
        let safetyDetailsVisible = false;

        function toggleSafetyDetails() {
            const details = document.getElementById('safety-details');
            const icon = document.getElementById('safety-toggle-icon');
            safetyDetailsVisible = !safetyDetailsVisible;

            if (safetyDetailsVisible) {
                details.style.display = 'block';
                icon.textContent = '‚ñ≤';
            } else {
                details.style.display = 'none';
                icon.textContent = '‚ñº';
            }
        }

        async function updateSafetyMonitor() {
            try {
                const apiBase = window.location.protocol + '//' + window.location.hostname + ':9905';
                const response = await fetch(`${apiBase}/api/safety-monitor/status`);
                const data = await response.json();

                if (data.status !== 'success') {
                    console.error('Safety monitor API error:', data);
                    return;
                }

                const safety = data.safety_status;
                const health = data.overall_health;

                // Update overall health indicator
                const indicator = document.getElementById('safety-health-indicator');
                const statusText = document.getElementById('safety-status-text');
                const widget = document.getElementById('safety-monitor');

                statusText.textContent = health;

                if (health === 'HEALTHY') {
                    indicator.style.background = '#4CAF50';
                    indicator.style.boxShadow = '0 0 10px #4CAF50';
                    widget.style.borderLeftColor = '#4CAF50';
                } else if (health === 'WARNING') {
                    indicator.style.background = '#FFC107';
                    indicator.style.boxShadow = '0 0 10px #FFC107';
                    widget.style.borderLeftColor = '#FFC107';
                } else if (health === 'ERROR') {
                    indicator.style.background = '#F44336';
                    indicator.style.boxShadow = '0 0 10px #F44336';
                    widget.style.borderLeftColor = '#F44336';
                }

                // Update messages
                const messagesDiv = document.getElementById('safety-messages');
                if (data.health_messages) {
                    let messages = [];
                    if (data.health_messages.errors) {
                        messages.push(...data.health_messages.errors.map(m => `‚ùå ${m}`));
                    }
                    if (data.health_messages.warnings) {
                        messages.push(...data.health_messages.warnings.map(m => `‚ö†Ô∏è ${m}`));
                    }
                    if (data.health_messages.info && !data.health_messages.errors && !data.health_messages.warnings) {
                        messages.push(...data.health_messages.info.map(m => `‚úÖ ${m}`));
                    }

                    if (messages.length > 0) {
                        messagesDiv.innerHTML = messages.join('<br>');
                        messagesDiv.style.display = 'block';
                    } else {
                        messagesDiv.style.display = 'none';
                    }
                } else {
                    messagesDiv.style.display = 'none';
                }

                // Update detail cards
                // Circuit Breaker
                document.getElementById('cb-status').textContent =
                    safety.circuit_breaker.tripped ? 'üî¥ TRIPPED' : 'üü¢ Active';
                document.getElementById('cb-failed-count').textContent =
                    safety.circuit_breaker.failed_command_count;

                // Position Limits
                document.getElementById('pos-open').textContent =
                    safety.position_limits.open_positions;
                document.getElementById('pos-max').textContent =
                    safety.position_limits.max_positions;
                document.getElementById('pos-util').textContent =
                    safety.position_limits.utilization_percent + '%';

                // Daily Drawdown
                if (safety.daily_drawdown.daily_pnl !== undefined) {
                    const pnl = safety.daily_drawdown.daily_pnl;
                    const pnlFormatted = `‚Ç¨${pnl >= 0 ? '+' : ''}${pnl.toFixed(2)}`;
                    document.getElementById('dd-pnl').textContent = pnlFormatted;
                    document.getElementById('dd-pnl').style.color = pnl >= 0 ? '#4CAF50' : '#F44336';
                }
                if (safety.daily_drawdown.limit_eur !== undefined) {
                    document.getElementById('dd-limit').textContent =
                        `‚Ç¨${safety.daily_drawdown.limit_eur.toFixed(2)}`;
                }

                // SL-Hit Cooldowns
                const cooldownsList = document.getElementById('sl-cooldowns-list');
                if (safety.sl_hit_cooldowns && Object.keys(safety.sl_hit_cooldowns).length > 0) {
                    const cooldowns = Object.entries(safety.sl_hit_cooldowns)
                        .map(([symbol, data]) =>
                            `${symbol}: ${data.remaining_minutes.toFixed(0)}min`
                        )
                        .join('<br>');
                    cooldownsList.innerHTML = cooldowns;
                } else {
                    cooldownsList.innerHTML = 'None active';
                }

                // Multi-Timeframe Conflicts
                const mtfList = document.getElementById('mtf-conflicts-list');
                if (safety.multi_timeframe_conflicts && safety.multi_timeframe_conflicts.length > 0) {
                    const conflicts = safety.multi_timeframe_conflicts
                        .map(c => `${c.symbol}: ${c.conflicts.length} conflict(s)`)
                        .join('<br>');
                    mtfList.innerHTML = conflicts;
                } else {
                    mtfList.innerHTML = 'No conflicts';
                }

                // News Filter
                document.getElementById('news-event-count').textContent =
                    safety.news_filter.total_upcoming || 0;

            } catch (error) {
                console.error('Error updating safety monitor:', error);
            }
        }

        // Version info for cache busting verification
        console.log('üöÄ Dashboard Version: 2025-10-10 - Multi-Timeframe & Safety Monitor');

        // Initialize Safety Monitor (must be called after function is defined)
        updateSafetyMonitor();  // Initial load
        setInterval(() => {
            updateSafetyMonitor();
        }, 5000);  // Update every 5 seconds
    </script>

    <!-- Trailing Stop Modal -->
    <div id="ts-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <h3 class="modal-title">üìà Set Trailing Stop</h3>
            <p style="color: #aaa; margin-bottom: 15px; font-size: 0.95em;">
                Ticket: #<span id="ts-ticket"></span> ‚Ä¢ <span id="ts-symbol"></span> ‚Ä¢ <span id="ts-volume"></span> lots
            </p>

            <!-- Quick Select Presets -->
            <div style="display: flex; gap: 8px; margin-bottom: 15px;">
                <button id="ts-conservative" class="modal-btn" style="flex: 1; background: #3a4a3a; font-size: 0.85em; padding: 10px 8px; line-height: 1.3; min-height: 60px;">
                    Conservative
                </button>
                <button id="ts-recommended" class="modal-btn" style="flex: 1; background: #2a5a2a; font-size: 0.85em; padding: 10px 8px; line-height: 1.3; min-height: 60px; border: 2px solid #4CAF50;">
                    Recommended ‚≠ê
                </button>
                <button id="ts-aggressive" class="modal-btn" style="flex: 1; background: #4a3a2a; font-size: 0.85em; padding: 10px 8px; line-height: 1.3; min-height: 60px;">
                    Aggressive
                </button>
            </div>

            <label style="color: #aaa; font-size: 0.9em; display: block; margin-bottom: 8px;">Custom Trailing Stop (pips):</label>
            <input type="number" id="ts-input" class="modal-input" placeholder="e.g. 20" min="1" step="1">

            <!-- Live ‚Ç¨ Value Display -->
            <div id="ts-value-display" style="color: #aaa; font-size: 0.9em; margin-top: 10px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 5px; min-height: 20px; text-align: center;">
            </div>

            <p style="color: #666; font-size: 0.8em; margin-top: 8px; line-height: 1.4;">
                üí° <strong>Tip:</strong> Lower pips = tighter protection (locks profit sooner, higher risk of early exit).<br>
                Higher pips = more breathing room (less protection, allows bigger swings).
            </p>

            <div class="modal-buttons" style="margin-top: 15px;">
                <button onclick="closeModal('ts-modal')" class="modal-btn modal-btn-cancel">Cancel</button>
                <button onclick="setTrailingStop()" class="modal-btn modal-btn-primary">‚úì Activate TS</button>
            </div>
        </div>
    </div>

    <!-- Close All Confirmation Modal -->
    <div id="close-all-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 class="modal-title">‚ö†Ô∏è Close All Trades?</h3>
            <p style="color: #aaa; margin-bottom: 20px;">
                This will close ALL open positions immediately.<br>
                This action cannot be undone!
            </p>
            <div class="modal-buttons">
                <button onclick="closeModal('close-all-modal')" class="modal-btn modal-btn-cancel">Cancel</button>
                <button onclick="closeAllTrades()" class="modal-btn modal-btn-danger">Close All</button>
            </div>
        </div>
    </div>

</body>
</html>
