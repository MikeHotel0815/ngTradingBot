<!-- Price Charts Section with TP/SL Levels -->
<!-- This section displays live price charts with Take Profit and Stop Loss levels -->
<!-- Can be included in dashboard.html -->

<style>
.price-charts-section {
    margin: 20px 0;
    padding: 20px;
    background: #1a1a1a;
    border-radius: 8px;
    border: 1px solid #333;
}

.price-charts-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 20px;
}

.price-charts-header h2 {
    color: #e0e0e0;
    margin: 0;
    font-size: 24px;
}

.chart-controls {
    display: flex;
    gap: 10px;
    align-items: center;
}

.chart-controls select,
.chart-controls button {
    padding: 8px 12px;
    background: #2a2a2a;
    border: 1px solid #444;
    border-radius: 4px;
    color: #e0e0e0;
    cursor: pointer;
    font-size: 14px;
}

.chart-controls button:hover {
    background: #333;
}

.chart-controls button:active {
    background: #444;
}

.price-charts-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
    gap: 20px;
}

.price-chart-card {
    background: #222;
    border-radius: 8px;
    border: 1px solid #333;
    padding: 15px;
    transition: transform 0.2s;
}

.price-chart-card:hover {
    transform: translateY(-2px);
    border-color: #555;
}

.price-chart-card h3 {
    color: #10b981;
    margin: 0 0 10px 0;
    font-size: 18px;
}

.price-chart-card img {
    width: 100%;
    height: auto;
    border-radius: 4px;
}

.price-chart-loading {
    text-align: center;
    padding: 40px;
    color: #888;
    font-size: 16px;
}

.price-chart-error {
    text-align: center;
    padding: 40px;
    color: #ef4444;
    font-size: 16px;
}

.price-chart-timestamp {
    color: #888;
    font-size: 12px;
    margin-top: 10px;
    text-align: right;
}

.auto-refresh-toggle {
    display: flex;
    align-items: center;
    gap: 8px;
    color: #e0e0e0;
}

.auto-refresh-toggle input[type="checkbox"] {
    width: 16px;
    height: 16px;
    cursor: pointer;
}
</style>

<div class="price-charts-section">
    <div class="price-charts-header">
        <h2>ðŸ“ˆ Price Charts with TP/SL Levels</h2>
        <div class="chart-controls">
            <label for="timeframe-select" style="color: #e0e0e0;">Timeframe:</label>
            <select id="timeframe-select">
                <option value="M5">M5</option>
                <option value="M15">M15</option>
                <option value="H1" selected>H1</option>
                <option value="H4">H4</option>
                <option value="D1">D1</option>
            </select>

            <label for="bars-select" style="color: #e0e0e0;">Bars:</label>
            <select id="bars-select">
                <option value="50">50</option>
                <option value="100" selected>100</option>
                <option value="200">200</option>
                <option value="300">300</option>
            </select>

            <button id="refresh-charts-btn" onclick="refreshPriceCharts()">
                ðŸ”„ Refresh Charts
            </button>

            <div class="auto-refresh-toggle">
                <input type="checkbox" id="auto-refresh-checkbox" checked />
                <label for="auto-refresh-checkbox">Auto-refresh (30s)</label>
            </div>
        </div>
    </div>

    <div id="price-charts-container">
        <div class="price-chart-loading">
            Loading price charts...
        </div>
    </div>
</div>

<script>
// Price Charts with TP/SL - Live Updates via SocketIO
(function() {
    let autoRefreshInterval = null;
    const AUTO_REFRESH_INTERVAL_MS = 30000; // 30 seconds

    // Request price charts from server
    function refreshPriceCharts() {
        const timeframe = document.getElementById('timeframe-select').value;
        const bars = parseInt(document.getElementById('bars-select').value);

        console.log(`Requesting price charts: timeframe=${timeframe}, bars=${bars}`);

        // Show loading
        const container = document.getElementById('price-charts-container');
        container.innerHTML = '<div class="price-chart-loading">Generating charts...</div>';

        // Request via SocketIO (if connected)
        if (window.socket && window.socket.connected) {
            window.socket.emit('request_all_price_charts', {
                timeframe: timeframe,
                bars: bars
            });
        } else {
            // Fallback to REST API
            fetch(`/api/price-charts?timeframe=${timeframe}&bars=${bars}`)
                .then(response => response.json())
                .then(data => {
                    displayPriceCharts(data);
                })
                .catch(error => {
                    console.error('Error fetching price charts:', error);
                    container.innerHTML = `<div class="price-chart-error">Error loading charts: ${error.message}</div>`;
                });
        }
    }

    // Display price charts
    function displayPriceCharts(data) {
        const container = document.getElementById('price-charts-container');

        if (!data.charts || data.charts.length === 0) {
            container.innerHTML = '<div class="price-chart-error">No open trades found. Charts will appear when trades are opened.</div>';
            return;
        }

        let html = '<div class="price-charts-grid">';

        data.charts.forEach(chart => {
            const timestamp = data.generated_at ? new Date(data.generated_at).toLocaleString() : 'Just now';

            html += `
                <div class="price-chart-card">
                    <h3>${chart.symbol}</h3>
                    <img src="${chart.image}" alt="${chart.symbol} Price Chart" />
                    <div class="price-chart-timestamp">Generated: ${timestamp}</div>
                </div>
            `;
        });

        html += '</div>';
        container.innerHTML = html;

        console.log(`Displayed ${data.charts.length} price charts`);
    }

    // Setup SocketIO event listeners
    function setupSocketIO() {
        if (!window.socket) {
            console.warn('SocketIO not available, using REST API only');
            return;
        }

        // Listen for price charts updates
        window.socket.on('price_charts_update', function(data) {
            console.log('Received price charts update via SocketIO');
            displayPriceCharts(data);
        });

        // Listen for single price chart updates
        window.socket.on('price_chart_update', function(data) {
            console.log(`Received price chart update for ${data.symbol}`);
            // Update single chart in grid
            const chartCard = document.querySelector(`.price-chart-card[data-symbol="${data.symbol}"]`);
            if (chartCard) {
                const img = chartCard.querySelector('img');
                const timestamp = chartCard.querySelector('.price-chart-timestamp');
                img.src = data.image;
                timestamp.textContent = `Generated: ${new Date(data.generated_at).toLocaleString()}`;
            }
        });
    }

    // Setup auto-refresh
    function setupAutoRefresh() {
        const checkbox = document.getElementById('auto-refresh-checkbox');

        function toggleAutoRefresh() {
            if (checkbox.checked) {
                console.log('Auto-refresh enabled (30s interval)');
                autoRefreshInterval = setInterval(refreshPriceCharts, AUTO_REFRESH_INTERVAL_MS);
            } else {
                console.log('Auto-refresh disabled');
                if (autoRefreshInterval) {
                    clearInterval(autoRefreshInterval);
                    autoRefreshInterval = null;
                }
            }
        }

        checkbox.addEventListener('change', toggleAutoRefresh);

        // Start auto-refresh if enabled by default
        toggleAutoRefresh();
    }

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', function() {
            setupSocketIO();
            setupAutoRefresh();
            refreshPriceCharts(); // Initial load
        });
    } else {
        setupSocketIO();
        setupAutoRefresh();
        refreshPriceCharts(); // Initial load
    }

    // Make refreshPriceCharts globally available
    window.refreshPriceCharts = refreshPriceCharts;
})();
</script>
